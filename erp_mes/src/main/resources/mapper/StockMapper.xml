<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.erp_mes.mes.stock.mapper.StockMapper">
    
    <!-- 결과 매핑 -->
    <resultMap id="stockResultMap" type="com.erp_mes.mes.stock.dto.StockDTO">
        <result property="productId" column="product_id"/>
        <result property="productName" column="product_name"/>
        <result property="productType" column="product_type"/>
        <result property="itemAmount" column="item_amount"/>
        <result property="warehouseName" column="warehouse_name"/>
        <result property="warehouseId" column="warehouse_id"/>
        <result property="locationId" column="location_id"/>
    </resultMap>
    
    <resultMap id="warehouseResultMap" type="com.erp_mes.mes.stock.dto.WarehouseDTO">
        <result property="warehouseId" column="warehouse_id"/>
        <result property="warehouseName" column="warehouse_name"/>
    </resultMap>
    
    <!-- 재고 목록 조회 -->
    <select id="getStockList" resultMap="stockResultMap">
	    SELECT 
	        p.product_id,
	        p.product_name,
	        p.product_type,
	        wi.item_amount,
	        w.warehouse_name,
	        w.warehouse_location,  <!-- 추가 -->
	        w.warehouse_id,
	        wi.location_id
	    FROM warehouse_item wi
	    INNER JOIN product p ON wi.product_id = p.product_id
	    INNER JOIN warehouse w ON wi.warehouse_id = w.warehouse_id
	    WHERE wi.use_yn = 'Y'
	    ORDER BY p.product_id
	</select>
    
    <!-- 창고 목록 조회 -->
    <select id="getWarehouseList" resultMap="warehouseResultMap">
        SELECT 
            warehouse_id,
            warehouse_name
        FROM warehouse
        WHERE warehouse_status = 'Y'
        ORDER BY warehouse_name
    </select>
    
    <!-- 재고 상세 조회 -->
    <select id="getStockDetail" resultMap="stockResultMap">
        SELECT 
            p.product_id,
            p.product_name,
            p.product_type,
            wi.item_amount,
            w.warehouse_name,
            w.warehouse_id,
            wi.location_id
        FROM warehouse_item wi
        INNER JOIN product p ON wi.product_id = p.product_id
        INNER JOIN warehouse w ON wi.warehouse_id = w.warehouse_id
        WHERE p.product_id = #{productId}
        AND wi.use_yn = 'Y'
    </select>
    
    <!-- 재고 수량 업데이트 -->
    <update id="updateStockAmount">
        UPDATE warehouse_item
        SET item_amount = #{itemAmount},
            update_date = SYSDATE
        WHERE product_id = #{productId}
        AND warehouse_id = #{warehouseId}
    </update>
    
</mapper>
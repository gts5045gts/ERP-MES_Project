<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.erp_mes.mes.business.mapper.ShipmentMapper">
	<select id="getStatusOrder" resultType="com.erp_mes.mes.business.dto.OrderDTO">
		SELECT 
			order_id,
			client_name,
			order_date,
			delivery_date
		FROM 
		 	orders
		 WHERE
		 	order_status = 'RECEIVED' OR order_status = 'INPRODUCTION'
	</select>
	
	<select id="getOrderDetailWithStock" resultType="com.erp_mes.mes.business.dto.OrderDetailDTO">
        SELECT
            od.order_id,
            od.product_id,
            od.product_name,
            COALESCE(wi.stockQty, 0) AS stockQty,	-- 서브쿼리에서 계산된 총 재고량 
            od.order_qty,
            od.order_qty AS shipmentQty				-- 출하수량
        FROM
            orders_detail od
        LEFT JOIN (
        	SELECT 
        		product_id,
        		SUM(item_amount) AS stockQty -- 같은 제품이지만 위치가 다를 수 있기 때문에(=product_id = 'PRD001'인 컬럼이 여러개) 재고량 더하기
        	FROM
        		warehouse_item
        	GROUP BY
        		product_id
        ) wi ON od.product_id = wi.product_id
        WHERE
        	od.order_id = #{orderId}
    </select>
    
<!-- 전체 shipment 개수 가져오기 -->
  	<select id="countShipment" resultType="int">
  		SELECT 
  			COUNT(*)
  		FROM 
  			shipment
  	</select>
    
<!-- 출하(shipment) insert -->
  	<insert id="insertShipment" parameterType="com.erp_mes.mes.business.dto.ShipmentDTO">
  		INSERT INTO shipment (
  			shipment_id,
        	order_id, 
        	client_id, 
        	emp_id,
        	shipment_status, 
        	shipment_date,
        	delivery_date, 
        	update_at
   		) VALUES (
   			#{shipmentId},
        	#{orderId},
        	#{clientId}, 
        	#{empId},
        	#{shipmentStatus},
        	SYSDATE,
        	#{deliveryDate, jdbcType=DATE}, 
        	SYSDATE
    	)
	</insert>

	<select id="getOrderInfoByOrderId" resultType="com.erp_mes.mes.business.dto.OrderDTO" parameterType="string">
        SELECT 
        	order_id AS orderId,
        	client_id AS clientId,
        	delivery_date AS deliveryDate
        FROM
        	orders
        WHERE
        	order_id = #{orderId}
    </select>

<!-- 출하 상세 (shipment_detail) insert -->
  	<insert id="insertShipmentDetail" parameterType="com.erp_mes.mes.business.dto.ShipmentDetailDTO">
    	INSERT INTO shipment_detail (
    		id,
    		shipment_id,
    		product_id,
    		order_qty,
			shipment_qty,
			shipment_detail_status,
    		create_at,
    		update_at
    	) VALUES (
    		#{id},
    		#{shipmentId},
    		#{productId},
    		#{orderQty},
			#{shipmentQty},
			#{shipmentDetailStatus},
    		SYSDATE,
    		SYSDATE
    	)
  	</insert>
  	
<!--   	출하 목록 조회 -->
	<select id="getAllShipment" resultType="com.erp_mes.mes.business.dto.ShipmentDTO">
		SELECT
			s.shipment_id AS shipmentId,
			s.order_id AS orderId,
			s.client_id AS clientId,
			s.emp_id AS empId,
			s.shipment_status AS shipmentStatus,
			s.shipment_date AS shipmentDate,
			s.delivery_date AS deliveryDate,
			e.emp_name AS empName,
			c.client_name AS clientName
		FROM shipment s
		LEFT JOIN employee e ON s.emp_id = e.emp_id
		LEFT JOIN client c ON s.client_id = c.client_id
	</select>
	
<!-- 		출하 상세 목록 조회 -->
	<select id="getShipmentDetailsByShipmentId" resultType="com.erp_mes.mes.business.dto.ShipmentDetailDTO">
		SELECT
	    	sd.id,
	    	sd.shipment_id,
			sd.product_id,
           	p.product_name AS productName,					
            sd.order_qty,
            sd.shipment_qty,
            sd.shipment_detail_status
        FROM
            shipment_detail sd
        INNER JOIN
        	product p ON sd.product_id = p.product_id 
        WHERE
            sd.shipment_id = #{shipmentId}
	</select>
    
</mapper>
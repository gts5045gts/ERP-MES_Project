<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.erp_mes.mes.purchase.mapper.PurchaseMapper">

<!-- 전체 purchase 개수 가져오기 -->
  <select id="countPurchase" resultType="int">
  		SELECT 
  			COUNT(*)
  		FROM 
  			purchase
  </select>

<!-- 	발주 등록 모달창에 필요한 품목 리스트 -->
	<select id="getAllMaterial" resultType="com.erp_mes.mes.stock.dto.MaterialDTO">
		SELECT 
			material_id,
			material_name,
			unit,
			price
		FROM   
			material
	</select>

<!-- 발주(puechase) insert -->
  <insert id="insertPurchase" parameterType="com.erp_mes.mes.purchase.dto.PurchaseDTO">
  		INSERT INTO purchase (
        	purchase_id, 
        	total_purchase_qty,
    		total_purchase_price,
    		client_id,
    		purchase_date,
    		input_date,
    		emp_id,
    		purchase_status,
    		update_at
   		) VALUES (
        	#{purchaseId},
        	#{totalPurchaseQty, jdbcType=INTEGER}, 
        	#{totalPurchasePrice,  jdbcType=INTEGER}, 
        	#{clientId},
        	SYSDATE,
        	#{inputDate, jdbcType=DATE},
        	#{empId},
        	'REQUEST', 
        	SYSDATE
    )
	</insert>
	
<!-- 발주 상세 (purchase_detail) insert -->
  <insert id="insertPurchaseDetail" parameterType="com.erp_mes.mes.purchase.dto.PurchaseDetailDTO">
    	INSERT INTO purchase_detail (
    		purchase_id,
    		id,
    		material_id,
    		material_name,
    		unit,
    		purchase_qty,
    		purchase_price,
    		purchase_detail_status,
    		create_at,
    		update_at
    	) VALUES (
    		#{purchaseId},
    		#{id},
    		#{materialId},
    		#{materialName},
    		#{unit},
    		#{purchaseQty},
    		#{purchasePrice},
    		'REQUEST',
    		SYSDATE,
    		SYSDATE
    	)
  </insert>

<!-- 발주 목록 조회 -->
	<select id="getAllPurchase" resultType="com.erp_mes.mes.purchase.dto.PurchaseDTO">
		SELECT
			p.purchase_id AS purchaseId,
			p.purchase_date AS purchaseDate,
			p.purchase_status AS purchaseStatus,
			p.client_id AS clientId,
			p.total_purchase_qty AS totalPurchaseQty,
			p.total_purchase_price AS totalPurchasePrice,
			p.input_date AS inputDate,
			p.emp_id AS empId,
			e.emp_name AS empName,
			c.client_name AS clientName
		FROM purchase p
		LEFT JOIN employee e ON p.emp_id = e.emp_id
		LEFT JOIN client c ON p.client_id = c.client_id
	</select>

<!-- 	발주 상세 목록 조회 -->
	<select id="getPurchaseDetailsByOrderId" resultType="com.erp_mes.mes.purchase.dto.PurchaseDetailDTO">
	    SELECT
	    	id,
	    	purchase_id,
			material_id,
           	material_name,					
            purchase_qty,
            unit,
            purchase_price,
            (purchase_qty * purchase_price) AS total_price,
            purchase_detail_status
        FROM
            purchase_detail 
        WHERE
            purchase_id = #{purchaseId}
	</select>
	
<!--  	 발주 수정 모달창에 기존 값 불러오기 -->
<!-- 	<select id="getPurchaseById" parameterType="string" resultMap="purchaseWithDetailsMap"> -->
<!--     	SELECT  -->
<!--         	p.purchase_id, -->
<!--         	p.client_id, -->
<!--         	p.client_name, -->
<!--         	p.purchase_date, -->
<!--         	p.total_purchase_qty, -->
<!--         	p.total_purchase_price, -->
<!--         	p.total_purchase_status, -->
<!--         	d.id, -->
<!--         	d.material_id, -->
<!--         	d.material_name, -->
<!--         	d.unit, -->
<!--         	d.purchase_qty, -->
<!--         	d.purchase_price -->
<!--     	FROM  -->
<!--     		purchase p -->
<!--     	LEFT JOIN  -->
<!--     		purchase_detail d ON p.purchase_id = d.purchase_id -->
<!--     	WHERE  -->
<!--     		p.purchase_id = #{purchaseId} -->
<!-- 	</select> -->
	
<!-- 	발주 update -->
<!--     <update id="updatePurchase" parameterType="com.erp_mes.mes.purchase.dto.PurchaseDTO"> -->
<!--         UPDATE purchase -->
<!--         SET -->
<!--             input_date = #{inputDate}, -->
<!--             total_purchase_qty = #{totalPurchaseQty}, -->
<!--             total_purchase_price = #{totalPurchasePrice}, -->
<!--             update_at = SYSDATE -->
<!--         WHERE -->
<!--             purchase_id = #{purchaseId} -->
<!--     </update>	 -->
	
</mapper>
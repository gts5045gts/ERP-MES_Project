<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.erp_mes.mes.stock.mapper.WareMapper">
    
    <!-- 창고 목록 조회 -->
    <select id="selectWarehouseList" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
        SELECT 
            w.warehouse_id as warehouseId,
            w.warehouse_name as warehouseName,
            w.warehouse_type as warehouseType,
            w.warehouse_status as warehouseStatus,
            w.warehouse_location as warehouseLocation,
            w.emp_id as empId,
            e.emp_name as empName,
            w.description,
            w.create_date as createDate,
            w.update_date as updateDate
        FROM warehouse w
        LEFT JOIN employee e ON w.emp_id = e.emp_id
        WHERE 1=1
        <if test="warehouseType != null and warehouseType != ''">
            AND w.warehouse_type = #{warehouseType}
        </if>
        <if test="warehouseStatus != null and warehouseStatus != ''">
            AND w.warehouse_status = #{warehouseStatus}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (w.warehouse_id LIKE '%' || #{searchKeyword} || '%'
                OR w.warehouse_name LIKE '%' || #{searchKeyword} || '%')
        </if>
        ORDER BY w.create_date DESC
    </select>
    
    <!-- 창고 중복 체크 -->
    <select id="existsWarehouseById" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM warehouse
        WHERE warehouse_id = #{warehouseId}
    </select>
    
    <!-- 창고 등록 -->
    <insert id="insertWarehouse">
        INSERT INTO warehouse (
            warehouse_id, 
            warehouse_name, 
            warehouse_type, 
            warehouse_status,
            warehouse_location, 
            emp_id, 
            description, 
            create_date
        ) VALUES (
            #{warehouseId}, 
            #{warehouseName}, 
            #{warehouseType}, 
            #{warehouseStatus},
            #{warehouseLocation}, 
            #{empId}, 
            #{description}, 
            SYSDATE
        )
    </insert>
    
    <!-- 창고 수정 -->
    <update id="updateWarehouse">
	    UPDATE warehouse
	    SET warehouse_name = #{warehouseName},
	        warehouse_type = #{warehouseType},
	        warehouse_status = #{warehouseStatus},
	        warehouse_location = #{warehouseLocation},
	        emp_id = #{empId}, 
	        description = #{description},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	</update>
    
    <!-- 창고 삭제 -->
    <delete id="deleteWarehouses">
        DELETE FROM warehouse
        WHERE warehouse_id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>
    
    <!-- 창고 사용중 체크 (창고에 재고가 있는지) -->
    <select id="checkWarehouseInUse" resultType="int">
        SELECT COUNT(*) 
        FROM warehouse_item
        WHERE warehouse_id = #{warehouseId}
        AND item_amount > 0
    </select>
    
    <!-- 입고 목록 조회 -->
	<select id="selectInputList" resultType="map">
	    SELECT 
	        i.in_id as "inId",
	        i.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        i.material_id as "materialId",
	        m.material_name as "materialName",
	        i.product_id as "productId",  
	        p.product_name as "productName",  
	        i.client_id as "clientId",
	        c.client_name as "clientName",
	        i.in_count as "inCount",
	        i.emp_id as "empId",
	        e.emp_name as "empName",
	        i.in_status as "inStatus",
	        i.in_type as "inType",
	        TO_CHAR(i.in_complete, 'YYYY-MM-DD HH24:MI:SS') as "inComplete",
	        i.location_id as "locationId",
	        i.batch_id as "batchId"
	    FROM input i
	    LEFT JOIN warehouse w ON i.warehouse_id = w.warehouse_id
	    LEFT JOIN material m ON i.material_id = m.material_id
	    LEFT JOIN product p ON i.product_id = p.product_id  
	    LEFT JOIN client c ON i.client_id = c.client_id
	    LEFT JOIN employee e ON i.emp_id = e.emp_id
	    WHERE 1=1
	    ORDER BY i.in_complete DESC
	</select>
	
	<!-- Product warehouse_item 관련 쿼리 -->
	<select id="getPartiallyFilledLocationsProduct" resultType="map">
	    <![CDATA[
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND item_amount < #{maxAmount}
	    AND use_yn = 'Y'
	    ORDER BY item_amount ASC
	    ]]>
	</select>
	
	<update id="updateWarehouseItemAmountProduct" parameterType="map">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{addAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId}
	    AND product_id = #{productId}
	</update>

	<insert id="insertWarehouseItemProduct" parameterType="map">
	    INSERT INTO warehouse_item (
	        manage_id,
	        warehouse_id,
	        product_id,
	        item_amount,
	        location_id,
	        use_yn,
	        create_date,
	        emp_id
	    ) VALUES (
	        #{manageId},
	        #{warehouseId},
	        #{productId},
	        #{itemAmount},
	        #{locationId},
	        'Y',
	        SYSDATE,
	        #{empId}
	    )
	</insert>
	
	<!-- 빈 위치 조회 -->
	<select id="getEmptyLocations" resultType="string">
	    SELECT il.location_id
	    FROM item_location il
	    WHERE il.warehouse_id = #{warehouseId}
	    AND il.zone_yn = 'Y'
	    AND NOT EXISTS (
	        SELECT 1 
	        FROM warehouse_item wi
	        WHERE wi.location_id = il.location_id
	        AND wi.item_amount > 0
	    )
	    ORDER BY il.loc_zone, il.loc_rack, il.loc_level, il.loc_cell
	    FETCH FIRST 10 ROWS ONLY
	</select>
	
	<!-- 오늘 입고 건수 조회 -->
	<select id="getTodayInputCount" resultType="int">
	    SELECT NVL(COUNT(*), 0)
	    FROM input
	    WHERE in_id LIKE 'IN' || #{today} || '%'
	</select>
	
	<!-- 입고 등록 -->
	<insert id="insertInput" parameterType="map">
	    INSERT INTO input (
	        in_id, 
	        warehouse_id,
	        <if test="productId != null">
	            product_id,
	        </if>
	        <if test="materialId != null">
	            material_id,
	        </if>
	        client_id, 
	        in_count, 
	        emp_id, 
	        in_status,
	        in_type,
	        batch_id,
	        in_reason,
	        in_remark,
	        in_complete
	    ) VALUES (
	        #{inId}, 
	        #{warehouseId},
	        <if test="productId != null">
	            #{productId},
	        </if>
	        <if test="materialId != null">
	            #{materialId},
	        </if>
	        #{clientId},
	        #{inCount}, 
	        #{empId}, 
	        #{inStatus},
	        #{inType, jdbcType=VARCHAR},
	        #{batchId, jdbcType=VARCHAR},
	        #{inReason, jdbcType=VARCHAR},
	        #{inRemark, jdbcType=VARCHAR},
	        SYSDATE
	    )
	</insert>
	
	<!-- 입고 상세 조회 -->
	<select id="selectInputById" resultType="map">
	    SELECT * FROM input WHERE in_id = #{inId}
	</select>

	
	<!-- 입고 상태 업데이트 -->
	<update id="updateInputStatusWithReason">
	    UPDATE input 
	    SET in_status = #{status},
	        in_reason = #{reason},
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- 재고 증가 -->
	<update id="increaseStock">
	    UPDATE warehouse_item 
	    SET item_amount = item_amount + #{inCount},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- 입고 상태 업데이트 (단순 상태만 변경) -->
	<update id="updateInputStatus">
	    UPDATE input 
	    SET in_status = #{status},
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- 부품 목록 조회 -->
	<select id="selectPartsList" resultType="map">
	    SELECT 
	        product_id as "productId",
	        product_name as "productName"
	    FROM product
	    WHERE product_type = '부품'
	    ORDER BY product_name
	</select>
	
	<!-- 완제품 목록 조회 -->
	<select id="selectProductsForInput" resultType="map">
	    SELECT 
	        product_id as "productId",
	        product_name as "productName"
	    FROM product
	    WHERE product_type = 'PTYPE001'
	    ORDER BY product_name
	</select>
	
	<select id="selectTodayProductionForInput" resultType="map">
	    SELECT 
	        wr.result_id as "resultId",
	        wr.work_order_id as "workOrderId", 
	        wr.good_qty as "availableQty",
	        pp.product_id as "productId",
	        p.product_name as "productName",
	        TO_CHAR(wr.created_at, 'YYYY-MM-DD HH24:MI') as "productionTime",
	        wo.emp_id as "workerId"
	    FROM work_result wr
	    INNER JOIN work_order wo ON wr.work_order_id = wo.work_order_id
	    INNER JOIN product_plan pp ON wo.plan_id = pp.plan_id
	    INNER JOIN product p ON pp.product_id = p.product_id
	    WHERE wr.in_id IS NULL
	    AND wr.good_qty > 0
	    ORDER BY wr.created_at DESC
	</select>
	
	<!-- work_result의 in_id 업데이트 -->
	<update id="updateWorkResultInId">
	    UPDATE work_result
	    SET in_id = #{inId},
	        updated_at = SYSDATE
	    WHERE result_id = #{resultId}
	</update>
	
	<!-- 단순 카운트 쿼리들 -->
	<select id="countWorkResult" resultType="int">
	    SELECT COUNT(*) FROM work_result
	</select>
	
	<select id="countNullInId" resultType="int">
	    SELECT COUNT(*) FROM work_result WHERE in_id IS NULL AND good_qty > 0
	</select>
	
	<select id="testDirectQuery" resultType="map">
	    SELECT 
	        1 as "resultId",
	        'TEST' as "productId"
	    FROM work_result 
	    WHERE ROWNUM = 1
	</select>
	
	<!-- 거래처 목록 조회 (PURCHASE 타입만) -->
	<select id="selectClientsList" resultType="map">
	    SELECT 
	        client_id as "clientId",
	        client_name as "clientName"
	    FROM client
	    WHERE client_status = 'ACTIVE'
	    AND client_type = 'PURCHASE' 
	    ORDER BY client_name
	</select>
	
	<!-- 반려 사유 공통코드 조회 -->
	<select id="selectRejectReasons" resultType="map">
	    SELECT 
	        com_dt_id as "code",
	        com_dt_nm as "name"
	    FROM common_dt_code
	    WHERE UPPER(com_id) = 'DEFECT'
	    AND use_yn = 'Y'
	    ORDER BY com_dt_id
	</select>
	
	<!-- 창고 타입별 조회 -->
	<select id="selectWarehouseListByType" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
	    SELECT 
	        warehouse_id as warehouseId,
	        warehouse_name as warehouseName
	    FROM warehouse
	    WHERE warehouse_type = #{warehouseType}
	    AND warehouse_status = 'Y'
	    ORDER BY warehouse_name
	</select>
	
	<!-- product 테이블 재고 증가 -->
	<update id="updateProductQuantity">
	    UPDATE product 
	    SET quantity = NVL(quantity, 0) + #{inCount}
	    WHERE product_id = #{productId}
	</update>
	
	<!-- 배치별 그룹화된 입고 목록 -->
	<select id="selectGroupedInputList" resultType="map">
	    SELECT 
	        batch_id as "batchId",
	        TO_CHAR(MAX(in_complete), 'YYYY-MM-DD') as "inDate",
	        TO_CHAR(MAX(in_complete), 'HH24:MI') as "inTime",
	        MAX(in_type) as "inType",
	        COUNT(*) as "totalCount",  <!-- 품목 수를 COUNT(*)로 변경 -->
	        SUM(in_count) as "totalQty",  <!-- 총 수량 추가 -->
	        MAX(i.emp_id) as "empId",
	        MAX(e.emp_name) as "empName"
	    FROM input i
	    LEFT JOIN employee e ON i.emp_id = e.emp_id
	    WHERE batch_id IS NOT NULL
	    <if test="date != null and date != ''">
	        AND TRUNC(in_complete) = TO_DATE(#{date}, 'YYYY-MM-DD')
	    </if>
	    <if test="inType != null and inType != ''">
	        AND in_type = #{inType}
	    </if>
	    GROUP BY batch_id
	    ORDER BY MAX(in_complete) DESC
	</select>
	
	<!-- 오늘 배치 건수 조회 -->
	<select id="getTodayBatchCount" resultType="int">
	    SELECT NVL(COUNT(DISTINCT batch_id), 0)
	    FROM input
	    WHERE batch_id LIKE 'B' || #{today} || '%'
	</select>
	
	<!-- 배치ID로 입고 목록 조회 -->
	<select id="selectInputListByBatch" resultType="map">
	    SELECT 
	        i.in_id as "inId",
	        i.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        i.material_id as "materialId",
	        m.material_name as "materialName",
	        i.product_id as "productId",
	        p.product_name as "productName",
	        i.client_id as "clientId",
	        c.client_name as "clientName",
	        i.in_count as "inCount",
	        i.emp_id as "empId",
	        e.emp_name as "empName",
	        i.in_status as "inStatus",
	        i.in_type as "inType",
	        i.in_reason as "inReason",
	        i.in_remark as "inRemark",
	        TO_CHAR(i.in_complete, 'YYYY-MM-DD HH24:MI:SS') as "inComplete",
	        i.location_id as "locationId",
	        i.batch_id as "batchId"
	    FROM input i
	    LEFT JOIN warehouse w ON i.warehouse_id = w.warehouse_id
	    LEFT JOIN material m ON i.material_id = m.material_id
	    LEFT JOIN product p ON i.product_id = p.product_id
	    LEFT JOIN client c ON i.client_id = c.client_id
	    LEFT JOIN employee e ON i.emp_id = e.emp_id
	    WHERE i.batch_id = #{batchId}
	    ORDER BY i.in_complete DESC
	</select>
	
	<!-- 재사용 가능한 위치 조회 (item_amount = 0인 곳) -->
	<select id="getReusableLocations" resultType="string">
	    SELECT location_id 
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND material_id = #{materialId}
	    AND item_amount = 0
	    AND use_yn = 'Y'
	    ORDER BY location_id
	</select>
	
	<!-- 입고 위치 업데이트 -->
    <update id="updateInputLocation">
	    UPDATE input 
	    SET location_id = #{locationId},
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- item_location 테이블에 새 위치 추가 -->
	<insert id="insertItemLocation" parameterType="map">
	    INSERT INTO item_location (
	        warehouse_id, location_id, loc_zone, loc_rack, 
	        loc_level, loc_cell, zone_yn, emp_id, create_date
	    ) VALUES (
	        #{warehouseId}, #{locationId}, #{locZone}, #{locRack},
	        #{locLevel}, #{locCell}, #{zoneYn}, #{empId}, SYSDATE
	    )
	</insert>
	
	<!-- warehouse_item 저장/업데이트 -->
	<insert id="insertOrUpdateWarehouseItem" parameterType="map">
	    MERGE INTO warehouse_item wi
	    USING (SELECT #{locationId} as location_id FROM dual) src
	    ON (wi.location_id = src.location_id AND wi.product_id = #{productId})
	    WHEN MATCHED THEN
	        UPDATE SET 
	            item_amount = item_amount + #{itemAmount},
	            update_date = SYSDATE
	    WHEN NOT MATCHED THEN
	        INSERT (manage_id, warehouse_id, product_id, item_amount, 
	                use_yn, create_date, location_id, emp_id)
	        VALUES (#{manageId}, #{warehouseId}, #{productId}, #{itemAmount},
	                'Y', SYSDATE, #{locationId}, #{empId})
	</insert>
	
	<!-- 1000개 미만으로 채워진 위치 조회 -->
	<select id="getPartiallyFilledLocations" resultType="map">
	    <![CDATA[
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND item_amount < #{maxAmount}
	    AND use_yn = 'Y'
	    ORDER BY item_amount DESC
	    ]]>
	</select>

	<!-- 기존 위치에 수량 추가 -->
	<update id="updateWarehouseItemAmount">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{addAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId}
	    AND product_id = #{productId}
	</update>
	
	<!-- 새 위치에 삽입 -->
	<insert id="insertWarehouseItem" parameterType="map">
	    INSERT INTO warehouse_item (
	        manage_id, warehouse_id, product_id, item_amount,
	        use_yn, create_date, location_id, emp_id
	    ) VALUES (
	        #{manageId}, #{warehouseId}, #{productId}, #{itemAmount},
	        'Y', SYSDATE, #{locationId}, #{empId}
	    )
	</insert>
	
	<!-- Material 재고 증가 -->
	<update id="updateMaterialQuantity">
	    UPDATE material 
	    SET quantity = NVL(quantity, 0) + #{inCount}
	    WHERE material_id = #{materialId}
	</update>
	
	<!-- 부품/반제품만 조회 (입고용) -->
	<select id="selectMaterialsForInput" resultType="map">
	    SELECT 
	        material_id as "materialId",
	        material_name as "materialName", 
	        material_type as "materialType"
	    FROM material
	    WHERE material_type IN ('부품', '반제품')
	    ORDER BY material_type, material_name
	</select>
	
	<!-- Material용 부분채워진 위치 조회 -->
	<select id="getPartiallyFilledLocationsMaterial" resultType="map">
	    <![CDATA[
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND material_id = #{materialId}
	    AND item_amount < #{maxAmount}
	    AND use_yn = 'Y'
	    ORDER BY item_amount DESC
	    ]]>
	</select>
	
	<!-- Material warehouse_item 수량 추가 -->
	<update id="updateWarehouseItemAmountMaterial">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{addAmount, jdbcType=INTEGER},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId}
	    AND material_id = #{materialId}
	</update>
	
	<!-- 0924 input 테이블 manage_id 업데이트 -->
	<update id="updateInputManageId">
	    UPDATE input 
	    SET manage_id = #{manageId}
	    WHERE in_id = #{inId}
	</update>
	
	<!-- Material warehouse_item 신규 삽입 (중복 체크) -->
	<insert id="insertWarehouseItemMaterial">
	    INSERT INTO warehouse_item (
	        manage_id,
	        warehouse_id, 
	        material_id,
	        item_amount,
	        use_yn,
	        create_date,
	        location_id,
	        emp_id
	    ) SELECT 
	        #{manageId},
	        #{warehouseId},
	        #{materialId},
	        #{itemAmount},
	        'Y',
	        SYSDATE,
	        #{locationId},
	        #{empId}
	    FROM dual
	    WHERE NOT EXISTS (
	        SELECT 1 FROM warehouse_item 
	        WHERE location_id = #{locationId} 
	        AND material_id = #{materialId}
	    )
	</insert>
	
	<select id="getLocationCountForMaterial" resultType="int">
	    SELECT COUNT(DISTINCT location_id)
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND material_id = #{materialId}
	    AND item_amount > 0
	</select>
	
	
	<!-- manage_id로 재고 수량 조회 -->
	<select id="getMaterialStockByManageId" resultType="int">
	    SELECT NVL(item_amount, 0)
	    FROM warehouse_item
	    WHERE manage_id = #{manageId}
	    AND use_yn = 'Y'
	</select>
	<!-- 0924 manage_id별 Material 재고 조회 -->
	<select id="getMaterialStockGroupByManageId" resultType="map">
	    SELECT 
	        wi.manage_id as "manageId",
	        wi.material_id as "materialId",
	        wi.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        wi.location_id as "locationId",
	        wi.item_amount as "itemAmount",
	        TO_CHAR(wi.create_date, 'YYYY-MM-DD HH24:MI') as "createDate",
	        wi.emp_id as "empId"
	    FROM warehouse_item wi
	    INNER JOIN warehouse w ON wi.warehouse_id = w.warehouse_id
	    WHERE wi.material_id = #{materialId}
	    AND wi.item_amount > 0
	    AND wi.use_yn = 'Y'
	    ORDER BY wi.create_date ASC  <!-- 입고순(오래된것부터) -->
	</select>
	
	<!-- 이미 있으면 수량만 업데이트 -->
	<update id="updateExistingMaterialLocation">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{itemAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId} 
	    AND material_id = #{materialId}
	</update>
	
	<!-- ==================== 출고 관리 ==================== -->

	<!-- 출고 목록 조회 -->
	<select id="selectOutputList" resultType="map">
	    SELECT 
	        o.out_id as "outId",
	        o.product_id as "productId",
	        o.material_id as "materialId", 
	        o.out_count as "outCount",
	        o.out_type as "outType",  
	        o.batch_id as "batchId",
	        TO_CHAR(o.out_complete, 'YYYY-MM-DD HH24:MI') as "outDate"
	    FROM output o
	    WHERE 1=1
	    <if test="outType != null and outType != ''">
	        AND o.out_type = #{outType}
	    </if>
	    <if test="outStatus != null and outStatus != ''">
	        AND o.out_type = #{outStatus} 
	    </if>
	    ORDER BY o.out_id DESC
	</select>
	
	<!-- 오늘 출고 건수 -->
	<select id="getTodayOutputCount" resultType="int">
	    SELECT NVL(COUNT(*), 0)
	    FROM output
	    WHERE (out_id LIKE 'OUT' || #{today} || '%'
	       OR out_id LIKE 'MOUT' || #{today} || '%')
	</select>
	
	<!-- 오늘 배치 건수 -->
	<select id="getTodayOutputBatchCount" resultType="integer">
	    SELECT NVL(MAX(TO_NUMBER(SUBSTR(batch_id, -3))), 0)
	    FROM output 
	    WHERE batch_id LIKE 'MOB' || #{today} || '%'
	</select>
	
	<!-- 출고 등록 -->
	<insert id="insertOutput">
	    INSERT INTO output (
	        out_id, 
	        lot_id,  
	        product_id, 
	        material_id, 
	        warehouse_id, 
	        out_count, 
	        out_type, 
	        emp_id, 
	        batch_id, 
	        manage_id,
	        location_id,
	        update_date
	    ) VALUES (
	        #{outId}, 
	        #{lotId, jdbcType=VARCHAR},
	        #{productId, jdbcType=VARCHAR}, 
	        #{materialId, jdbcType=VARCHAR}, 
	        #{warehouseId}, 
	        #{outCount},
	        #{outType}, 
	        #{empId}, 
	        #{batchId},
	        #{manageId},
	        #{locationId, jdbcType=VARCHAR},
	        SYSDATE
	    )
	</insert>
	
	<insert id="insertLotMaster" parameterType="map">
	    INSERT INTO lot_master (
	        lot_id,
	        target_id,        
	        target_id_value, 
	        table_name,
	        type,
	        material_code,
	        created_at
	    ) VALUES (
	        #{lotId},
	        'out_id',         
	        #{targetId},      
	        #{tableName},
	        #{type},
	        #{materialCode},
	        SYSDATE
	    )
	</insert>
	
	<!-- Material인지 확인 -->
	<select id="checkIsMaterial" resultType="boolean">
	    SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
	    FROM material
	    WHERE material_id = #{productId}
	</select>
	
	<!-- 출고 정보 조회 -->
	<select id="selectOutputById" resultType="map">
	    SELECT * FROM output WHERE out_id = #{outId}
	</select>
	
	<!-- 출고 상태 변경 -->
	<update id="updateOutputStatus">
	    UPDATE output
	    SET out_status = #{status},
	        out_complete = SYSDATE,
	        update_date = SYSDATE
	    WHERE out_id = #{outId}
	</update>
	
	<!-- 배치별 출고 목록 조회 -->
	<select id="selectOutputListByBatch" resultType="map">
	    SELECT 
	        o.out_id as "outId",
	        CASE 
	            WHEN o.product_id IS NOT NULL THEN o.product_id
	            WHEN o.material_id IS NOT NULL THEN o.material_id
	            ELSE 'UNKNOWN'
	        END as "productId",
	        CASE 
	            WHEN o.material_id IS NOT NULL THEN m.material_name
	            WHEN o.product_id IS NOT NULL THEN p.product_name
	            ELSE 'UNKNOWN'
	        END as "productName",
	        CASE 
	            WHEN o.material_id IS NOT NULL THEN m.unit
	            WHEN o.product_id IS NOT NULL THEN p.unit
	            ELSE 'EA'
	        END as "unit",
	        o.out_count as "outCount",
	        o.out_remark as "outRemark",
	        o.out_type as "outType",
	        o.batch_id as "batchId",
	        o.warehouse_id as "warehouseId",
	        o.emp_id as "empId",
	        e.emp_name as "empName",
	        TO_CHAR(o.update_date, 'YYYY-MM-DD HH24:MI') as "outDate"
	    FROM output o
	    LEFT JOIN material m ON o.material_id = m.material_id
	    LEFT JOIN product p ON o.product_id = p.product_id
	    LEFT JOIN employee e ON o.emp_id = e.emp_id
	    WHERE o.batch_id = #{batchId}
	    ORDER BY o.out_id
	</select>
	
	<select id="getAllProductLocations" resultType="map">
	    SELECT 
	        wi.warehouse_id as "warehouseId",
	        wi.location_id as "locationId", 
	        wi.manage_id as "manageId",
	        wi.item_amount as "itemAmount"
	    FROM warehouse_item wi
	    WHERE wi.product_id = #{productId}
	    AND wi.item_amount > 0
	    AND wi.use_yn = 'Y'
	    ORDER BY wi.item_amount ASC
	</select>
	
	<!-- 날짜별 배치 목록 조회 -->
	<select id="selectOutputBatches" resultType="map">
	    SELECT 
	        batch_id as "batchId",
	        COUNT(*) as "itemCount",
	        SUM(out_count) as "totalCount",
	        TO_CHAR(MIN(update_date), 'YYYY-MM-DD') as "outDate",
	        TO_CHAR(MIN(update_date), 'HH24:MI') as "outTime"
	    FROM output
	    WHERE 1=1
	    AND batch_id IS NOT NULL  <!-- NULL 체크 추가 -->
	    <if test="outType != null and outType != ''">
	        <choose>
	            <when test="outType == 'material'">
	                AND material_id IS NOT NULL
	            </when>
	            <when test="outType == 'product'">
	                AND product_id IS NOT NULL
	            </when>
	        </choose>
	    </if>
	    GROUP BY batch_id
	    ORDER BY MIN(update_date) DESC
	</select>
	
	<!-- warehouse_item에서 manage_id 조회 -->
	<select id="getManageIdByWarehouse" resultType="string">
	    SELECT manage_id 
	    FROM warehouse_item 
	    WHERE (product_id = #{productId} OR material_id = #{productId})
	    AND warehouse_id = #{warehouseId}
	    AND use_yn = 'Y'
	    AND manage_id IS NOT NULL
	    AND ROWNUM = 1
	</select>
	
	<!-- Material 전체 재고 조회 -->
	<select id="getMaterialTotalStock" resultType="int">
	    SELECT NVL(SUM(item_amount), 0)
	    FROM warehouse_item
	    WHERE material_id = #{materialId}
	    AND use_yn = 'Y'
	</select>
	
	<!-- Product 전체 재고 조회 -->
	<select id="getProductTotalStock" resultType="int">
	    SELECT NVL(SUM(item_amount), 0)
	    FROM warehouse_item
	    WHERE product_id = #{productId}
	    AND use_yn = 'Y'
	</select>
	
	<!-- Product 재고 위치 조회 -->
	<select id="getProductStockLocations" resultType="map">
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE product_id = #{productId}
	    AND warehouse_id = #{warehouseId}
	    AND item_amount > 0
	    AND use_yn = 'Y'
	    ORDER BY item_amount ASC
	</select>
	
	<!-- Material 재고 위치 조회 -->
	<select id="getMaterialStockLocations" resultType="map">
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE material_id = #{materialId}
	    AND warehouse_id = #{warehouseId}
	    AND item_amount > 0
	    AND use_yn = 'Y'
	    ORDER BY item_amount ASC
	</select>
	
	<!-- warehouse_item Product 재고 차감 -->
	<update id="reduceWarehouseItemStock">
	    UPDATE warehouse_item
	    SET item_amount = item_amount - #{qty},
	        update_date = SYSDATE
	    WHERE product_id = #{productId}
	    AND warehouse_id = #{warehouseId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- warehouse_item Material 재고 차감 -->
	<update id="reduceMaterialWarehouseStock">
	    UPDATE warehouse_item
	    SET item_amount = item_amount - #{qty},
	        update_date = SYSDATE
	    WHERE material_id = #{materialId}
	    AND warehouse_id = #{warehouseId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- Product 수량 감소 -->
	<update id="reduceProductQuantity">
	    UPDATE product
	    SET quantity = quantity - #{qty}
	    WHERE product_id = #{productId}
	</update>
	
	<!-- Material 수량 감소 -->
	<update id="reduceMaterialQuantity">
	    UPDATE material
	    SET quantity = quantity - #{qty}
	    WHERE material_id = #{materialId}
	</update>
	
	<!-- 출고 삭제 -->
	<delete id="deleteOutput">
	    DELETE FROM output WHERE out_id = #{outId}
	</delete>
	
	<!-- 재고 포함 자재 목록 조회 (warehouse_item 합산) -->
	<select id="selectMaterialsWithStock" resultType="map">
	    SELECT 
	        m.material_id as "materialId",
	        m.material_name as "materialName",
	        m.material_type as "materialType",
	        NVL((SELECT SUM(wi.item_amount) 
	             FROM warehouse_item wi 
	             WHERE wi.material_id = m.material_id 
	             AND wi.use_yn = 'Y'), 0) as "quantity"
	    FROM material m
	    WHERE m.material_type IN ('부품', '반제품')
	    ORDER BY m.material_type, m.material_name
	</select>
	
	<!-- 재고 포함 완제품 목록 조회 (warehouse_item 합산) -->
	<select id="selectProductsWithStock" resultType="map">
	    SELECT 
	        p.product_id as "productId",
	        p.product_name as "productName",
	        '완제품' as "productType",
	        NVL((SELECT SUM(wi.item_amount) 
	             FROM warehouse_item wi 
	             WHERE wi.product_id = p.product_id 
	             AND wi.use_yn = 'Y'), 0) as "quantity"
	    FROM product p
	    WHERE p.product_type = 'PTYPE001'
	    ORDER BY p.product_name
	</select>
	
	<!-- 재고가 있는 창고 조회 -->
	<select id="getWarehousesWithStock" resultType="map">
	    SELECT DISTINCT
	        w.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        SUM(wi.item_amount) as "stock"
	    FROM warehouse w
	    INNER JOIN warehouse_item wi ON w.warehouse_id = wi.warehouse_id
	    WHERE (wi.product_id = #{productId} OR wi.material_id = #{productId})
	    AND wi.item_amount > 0
	    AND wi.use_yn = 'Y'
	    GROUP BY w.warehouse_id, w.warehouse_name
	    ORDER BY SUM(wi.item_amount) DESC
	</select>
	
	<!-- 0923 Material 재고 조회 -->
	<select id="getMtlStockQty" resultType="int">
	    SELECT NVL(item_amount, 0)
	    FROM warehouse_item
	    WHERE material_id = #{materialId}
	    AND warehouse_id = #{warehouseId}
	    AND location_id = #{locationId}
	    AND use_yn = 'Y'
	</select>
	
	<!-- Material warehouse_item 업데이트 -->
	<update id="updateMtlStock">
	    UPDATE warehouse_item
	    SET item_amount = #{newQty},
	        update_date = SYSDATE
	    WHERE material_id = #{materialId}
	    AND warehouse_id = #{warehouseId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- Material warehouse_item 삭제 -->
	<delete id="deleteMtlStock">
	    DELETE FROM warehouse_item
	    WHERE material_id = #{materialId}
	    AND warehouse_id = #{warehouseId}
	    AND location_id = #{locationId}
	</delete>
	
	<!-- Material 테이블 동기화 -->
	<update id="syncMaterialQty">
	    UPDATE material m
	    SET m.quantity = (
	        SELECT NVL(SUM(wi.item_amount), 0)
	        FROM warehouse_item wi
	        WHERE wi.material_id = m.material_id
	        AND wi.use_yn = 'Y'
	    )
	    WHERE m.material_id = #{materialId}
	</update>
	
	<!-- 모든 창고의 Material 재고 위치 조회 -->
	<select id="getAllMaterialLocations" resultType="map">
	    SELECT 
	        warehouse_id as "warehouseId",
	        location_id as "locationId",
	        item_amount as "itemAmount",
	        manage_id as "manageId"
	    FROM warehouse_item
	    WHERE material_id = #{materialId}
	    AND item_amount > 0
	    AND use_yn = 'Y'
	    ORDER BY item_amount ASC
	</select>
	
</mapper>
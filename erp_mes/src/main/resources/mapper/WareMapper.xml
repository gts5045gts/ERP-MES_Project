<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.erp_mes.mes.stock.mapper.WareMapper">
    
    <!-- 창고 목록 조회 -->
    <select id="selectWarehouseList" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
        SELECT 
            w.warehouse_id as warehouseId,
            w.warehouse_name as warehouseName,
            w.warehouse_type as warehouseType,
            w.warehouse_status as warehouseStatus,
            w.warehouse_location as warehouseLocation,
            w.emp_id as empId,
            e.emp_name as empName,
            w.description,
            w.create_date as createDate,
            w.update_date as updateDate
        FROM warehouse w
        LEFT JOIN employee e ON w.emp_id = e.emp_id
        WHERE 1=1
        <if test="warehouseType != null and warehouseType != ''">
            AND w.warehouse_type = #{warehouseType}
        </if>
        <if test="warehouseStatus != null and warehouseStatus != ''">
            AND w.warehouse_status = #{warehouseStatus}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (w.warehouse_id LIKE '%' || #{searchKeyword} || '%'
                OR w.warehouse_name LIKE '%' || #{searchKeyword} || '%')
        </if>
        ORDER BY w.create_date DESC
    </select>
    
    <!-- 창고 중복 체크 -->
    <select id="existsWarehouseById" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM warehouse
        WHERE warehouse_id = #{warehouseId}
    </select>
    
    <!-- 창고 등록 -->
    <insert id="insertWarehouse">
        INSERT INTO warehouse (
            warehouse_id, 
            warehouse_name, 
            warehouse_type, 
            warehouse_status,
            warehouse_location, 
            emp_id, 
            description, 
            create_date
        ) VALUES (
            #{warehouseId}, 
            #{warehouseName}, 
            #{warehouseType}, 
            #{warehouseStatus},
            #{warehouseLocation}, 
            #{empId}, 
            #{description}, 
            SYSDATE
        )
    </insert>
    
    <!-- 창고 수정 -->
    <update id="updateWarehouse">
	    UPDATE warehouse
	    SET warehouse_name = #{warehouseName},
	        warehouse_type = #{warehouseType},
	        warehouse_status = #{warehouseStatus},
	        warehouse_location = #{warehouseLocation},
	        emp_id = #{empId}, 
	        description = #{description},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	</update>
    
    <!-- 창고 삭제 -->
    <delete id="deleteWarehouses">
        DELETE FROM warehouse
        WHERE warehouse_id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>
    
    <!-- 창고 사용중 체크 (창고에 재고가 있는지) -->
    <select id="checkWarehouseInUse" resultType="int">
        SELECT COUNT(*) 
        FROM warehouse_item
        WHERE warehouse_id = #{warehouseId}
        AND item_amount > 0
    </select>
    
    <!-- 0917 입고 목록 조회 -->
	<select id="selectInputList" resultType="map">
	    SELECT 
	        i.in_id as "inId",
	        i.in_type as "inType",
	        i.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        i.product_id as "productId",
	        p.product_name as "productName",
	        i.client_id as "clientId",
	        c.client_name as "clientName",
	        i.in_count as "inCount",
	        i.location_id as "locationId",
	        i.in_status as "inStatus"
	    FROM input i
	    LEFT JOIN warehouse w ON i.warehouse_id = w.warehouse_id
	    LEFT JOIN product p ON i.product_id = p.product_id
	    LEFT JOIN client c ON i.client_id = c.client_id
	    WHERE 1=1
	    <if test="batchId != null and batchId != ''">
	        AND i.batch_id = #{batchId}
	    </if>
	    <if test="inType != null and inType != ''">
	        AND i.in_type = #{inType}
	    </if>
	    <if test="inStatus != null and inStatus != ''">
	        AND i.in_status = #{inStatus}
	    </if>
	    ORDER BY i.in_id DESC
	</select>
	
	<!-- 빈 위치 조회 -->
	<select id="getEmptyLocations" resultType="string">
	    SELECT il.location_id
	    FROM item_location il
	    WHERE il.warehouse_id = #{warehouseId}
	    AND il.zone_yn = 'Y'
	    AND NOT EXISTS (
	        SELECT 1 
	        FROM warehouse_item wi
	        WHERE wi.location_id = il.location_id
	        AND wi.item_amount > 0
	    )
	    ORDER BY il.loc_zone, il.loc_rack, il.loc_level, il.loc_cell
	    FETCH FIRST 10 ROWS ONLY
	</select>
	
	<!-- 오늘 입고 건수 조회 -->
	<select id="getTodayInputCount" resultType="int">
	    SELECT NVL(COUNT(*), 0)
	    FROM input
	    WHERE in_id LIKE 'IN' || #{today} || '%'
	</select>
	
	<!-- 입고 등록 -->
	<insert id="insertInput" parameterType="map">
	    INSERT INTO input (
	        in_id, 
	        warehouse_id, 
	        material_id,  
	        client_id, 
	        in_count, 
	        emp_id, 
	        in_status,
	        in_type,
	        batch_id,
	        in_complete
	    ) VALUES (
	        #{inId}, 
	        #{warehouseId}, 
	        #{materialId},  
	        #{clientId},
	        #{inCount}, 
	        #{empId}, 
	        #{inStatus},
	        #{inType, jdbcType=VARCHAR},
	        #{batchId, jdbcType=VARCHAR},
	        SYSDATE
	    )
	</insert>
	
	<!-- 입고 상세 조회 -->
	<select id="selectInputById" resultType="map">
	    SELECT * FROM input WHERE in_id = #{inId}
	</select>

	
	<!-- 입고 상태 업데이트 -->
	<update id="updateInputStatus">
	    UPDATE input 
	    SET in_status = #{status},
	        in_complete = SYSDATE,
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- 재고 증가 -->
	<update id="increaseStock">
	    UPDATE warehouse_item 
	    SET item_amount = item_amount + #{inCount},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- 부품 목록 조회 -->
	<select id="selectPartsList" resultType="map">
	    SELECT 
	        product_id as "productId",
	        product_name as "productName"
	    FROM product
	    WHERE product_type = '부품'
	    ORDER BY product_name
	</select>
	
	<!-- 거래처 목록 조회 (PURCHASE 타입만) -->
	<select id="selectClientsList" resultType="map">
	    SELECT 
	        client_id as "clientId",
	        client_name as "clientName"
	    FROM client
	    WHERE client_status = 'ACTIVE'
	    AND client_type = 'PURCHASE' 
	    ORDER BY client_name
	</select>
	
	<!-- 창고 타입별 조회 -->
	<select id="selectWarehouseListByType" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
	    SELECT 
	        warehouse_id as warehouseId,
	        warehouse_name as warehouseName
	    FROM warehouse
	    WHERE warehouse_type = #{warehouseType}
	    AND warehouse_status = 'Y'
	    ORDER BY warehouse_name
	</select>
	
	<!-- product 테이블 재고 증가 -->
	<update id="updateProductQuantity">
	    UPDATE product 
	    SET quantity = NVL(quantity, 0) + #{inCount}
	    WHERE product_id = #{productId}
	</update>
	
	<!-- 배치별 그룹화된 입고 목록 -->
	<select id="selectGroupedInputList" resultType="map">
	    SELECT 
	        batch_id as "batchId",
	        TO_CHAR(MAX(in_complete), 'YYYY-MM-DD') as "inDate",
	        TO_CHAR(MAX(in_complete), 'HH24:MI') as "inTime",
	        MAX(in_type) as "inType",
	        COUNT(*) as "totalCount",  <!-- 품목 수를 COUNT(*)로 변경 -->
	        SUM(in_count) as "totalQty",  <!-- 총 수량 추가 -->
	        MAX(i.emp_id) as "empId",
	        MAX(e.emp_name) as "empName"
	    FROM input i
	    LEFT JOIN employee e ON i.emp_id = e.emp_id
	    WHERE batch_id IS NOT NULL
	    <if test="date != null and date != ''">
	        AND TRUNC(in_complete) = TO_DATE(#{date}, 'YYYY-MM-DD')
	    </if>
	    <if test="inType != null and inType != ''">
	        AND in_type = #{inType}
	    </if>
	    GROUP BY batch_id
	    ORDER BY MAX(in_complete) DESC
	</select>
	
	<!-- 오늘 배치 건수 조회 -->
	<select id="getTodayBatchCount" resultType="int">
	    SELECT NVL(COUNT(DISTINCT batch_id), 0)
	    FROM input
	    WHERE batch_id LIKE 'B' || #{today} || '%'
	</select>
	
	<!-- 배치ID로 입고 목록 조회 -->
	<select id="selectInputListByBatch" resultType="map">
	    SELECT 
	        i.in_id as "inId",
	        i.in_type as "inType",
	        i.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        i.material_id as "materialId",
	        m.material_name as "materialName",
	        m.material_type as "materialType",
	        i.client_id as "clientId",
	        c.client_name as "clientName",
	        i.in_count as "inCount",
	        i.location_id as "locationId",  <!-- location_id 포함 -->
	        i.in_status as "inStatus",
	        i.emp_id as "empId",
	        e.emp_name as "empName",
	        TO_CHAR(i.in_complete, 'YYYY-MM-DD HH24:MI') as "inDate",
	        TO_CHAR(i.update_date, 'YYYY-MM-DD HH24:MI:SS') as "completeTime"
	    FROM input i
	    LEFT JOIN warehouse w ON i.warehouse_id = w.warehouse_id
	    LEFT JOIN material m ON i.material_id = m.material_id
	    LEFT JOIN client c ON i.client_id = c.client_id
	    LEFT JOIN employee e ON i.emp_id = e.emp_id
	    WHERE i.batch_id = #{batchId}
	    ORDER BY i.in_id
	</select>
	
	<!-- 입고 위치 업데이트 -->
    <update id="updateInputLocation">
	    UPDATE input 
	    SET location_id = #{locationId},
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- warehouse_item 저장/업데이트 -->
	<insert id="insertOrUpdateWarehouseItem" parameterType="map">
	    MERGE INTO warehouse_item wi
	    USING (SELECT #{locationId} as location_id FROM dual) src
	    ON (wi.location_id = src.location_id AND wi.product_id = #{productId})
	    WHEN MATCHED THEN
	        UPDATE SET 
	            item_amount = item_amount + #{itemAmount},
	            update_date = SYSDATE
	    WHEN NOT MATCHED THEN
	        INSERT (manage_id, warehouse_id, product_id, item_amount, 
	                use_yn, create_date, location_id, emp_id)
	        VALUES (#{manageId}, #{warehouseId}, #{productId}, #{itemAmount},
	                'Y', SYSDATE, #{locationId}, #{empId})
	</insert>
	
	<!-- 500개 미만으로 채워진 위치 조회 -->
	<select id="getPartiallyFilledLocations" resultType="map">
	    <![CDATA[
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND item_amount < #{maxAmount}
	    AND use_yn = 'Y'
	    ORDER BY item_amount DESC
	    ]]>
	</select>

	<!-- 기존 위치에 수량 추가 -->
	<update id="updateWarehouseItemAmount">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{addAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId}
	    AND product_id = #{productId}
	</update>
	
	<!-- 새 위치에 삽입 -->
	<insert id="insertWarehouseItem" parameterType="map">
	    INSERT INTO warehouse_item (
	        manage_id, warehouse_id, product_id, item_amount,
	        use_yn, create_date, location_id, emp_id
	    ) VALUES (
	        #{manageId}, #{warehouseId}, #{productId}, #{itemAmount},
	        'Y', SYSDATE, #{locationId}, #{empId}
	    )
	</insert>
	
	<!-- Material 재고 증가 -->
	<update id="updateMaterialQuantity">
	    UPDATE material 
	    SET quantity = NVL(quantity, 0) + #{inCount}
	    WHERE material_id = #{materialId}
	</update>
	
	<!-- 부품/반제품만 조회 (입고용) -->
	<select id="selectMaterialsForInput" resultType="map">
	    SELECT 
	        material_id as "materialId",
	        material_name as "materialName", 
	        material_type as "materialType"
	    FROM material
	    WHERE material_type IN ('부품', '반제품')
	    ORDER BY material_type, material_name
	</select>
	
	<!-- Material용 부분채워진 위치 조회 -->
	<select id="getPartiallyFilledLocationsMaterial" resultType="map">
	    <![CDATA[
	    SELECT 
	        location_id as "locationId",
	        item_amount as "itemAmount"
	    FROM warehouse_item
	    WHERE warehouse_id = #{warehouseId}
	    AND material_id = #{materialId}
	    AND item_amount < #{maxAmount}
	    AND use_yn = 'Y'
	    ORDER BY item_amount DESC
	    ]]>
	</select>
	
	<!-- Material warehouse_item 수량 추가 -->
	<update id="updateWarehouseItemAmountMaterial">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{addAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId}
	    AND material_id = #{materialId}
	</update>
	
	<!-- Material warehouse_item 신규 삽입 (중복 체크) -->
	<insert id="insertWarehouseItemMaterial" parameterType="map">
	    INSERT INTO warehouse_item (
	        manage_id, warehouse_id, material_id, item_amount,
	        use_yn, create_date, location_id, emp_id
	    ) 
	    SELECT 
	        #{manageId}, #{warehouseId}, #{materialId}, #{itemAmount},
	        'Y', SYSDATE, #{locationId}, #{empId}
	    FROM dual
	    WHERE NOT EXISTS (
	        SELECT 1 FROM warehouse_item 
	        WHERE location_id = #{locationId} 
	        AND material_id = #{materialId}
	    )
	</insert>
	
	<!-- 이미 있으면 수량만 업데이트 -->
	<update id="updateExistingMaterialLocation">
	    UPDATE warehouse_item
	    SET item_amount = item_amount + #{itemAmount},
	        update_date = SYSDATE
	    WHERE location_id = #{locationId} 
	    AND material_id = #{materialId}
	</update>
</mapper>
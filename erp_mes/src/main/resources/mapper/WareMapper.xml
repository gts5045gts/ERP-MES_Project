<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.erp_mes.mes.stock.mapper.WareMapper">
    
    <!-- 창고 목록 조회 -->
    <select id="selectWarehouseList" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
        SELECT 
            w.warehouse_id as warehouseId,
            w.warehouse_name as warehouseName,
            w.warehouse_type as warehouseType,
            w.warehouse_status as warehouseStatus,
            w.warehouse_location as warehouseLocation,
            w.emp_id as empId,
            e.emp_name as empName,
            w.description,
            w.create_date as createDate,
            w.update_date as updateDate
        FROM warehouse w
        LEFT JOIN employee e ON w.emp_id = e.emp_id
        WHERE 1=1
        <if test="warehouseType != null and warehouseType != ''">
            AND w.warehouse_type = #{warehouseType}
        </if>
        <if test="warehouseStatus != null and warehouseStatus != ''">
            AND w.warehouse_status = #{warehouseStatus}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (w.warehouse_id LIKE '%' || #{searchKeyword} || '%'
                OR w.warehouse_name LIKE '%' || #{searchKeyword} || '%')
        </if>
        ORDER BY w.create_date DESC
    </select>
    
    <!-- 창고 중복 체크 -->
    <select id="existsWarehouseById" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM warehouse
        WHERE warehouse_id = #{warehouseId}
    </select>
    
    <!-- 창고 등록 -->
    <insert id="insertWarehouse">
        INSERT INTO warehouse (
            warehouse_id, 
            warehouse_name, 
            warehouse_type, 
            warehouse_status,
            warehouse_location, 
            emp_id, 
            description, 
            create_date
        ) VALUES (
            #{warehouseId}, 
            #{warehouseName}, 
            #{warehouseType}, 
            #{warehouseStatus},
            #{warehouseLocation}, 
            #{empId}, 
            #{description}, 
            SYSDATE
        )
    </insert>
    
    <!-- 창고 수정 -->
    <update id="updateWarehouse">
	    UPDATE warehouse
	    SET warehouse_name = #{warehouseName},
	        warehouse_type = #{warehouseType},
	        warehouse_status = #{warehouseStatus},
	        warehouse_location = #{warehouseLocation},
	        emp_id = #{empId}, 
	        description = #{description},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	</update>
    
    <!-- 창고 삭제 -->
    <delete id="deleteWarehouses">
        DELETE FROM warehouse
        WHERE warehouse_id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>
    
    <!-- 창고 사용중 체크 (창고에 재고가 있는지) -->
    <select id="checkWarehouseInUse" resultType="int">
        SELECT COUNT(*) 
        FROM warehouse_item
        WHERE warehouse_id = #{warehouseId}
        AND item_amount > 0
    </select>
    
    <!-- 0917 입고 목록 조회 -->
	<select id="selectInputList" resultType="map">
	    SELECT 
	        i.in_id as "inId",
	        i.in_type as "inType",
	        i.warehouse_id as "warehouseId",
	        w.warehouse_name as "warehouseName",
	        i.product_id as "productId",
	        p.product_name as "productName",
	        i.client_id as "clientId",
	        c.client_name as "clientName",
	        i.in_count as "inCount",
	        i.location_id as "locationId",
	        i.in_status as "inStatus",
	        i.lot_id as "lotId",
	        i.in_complete as "inComplete"
	    FROM input i
	    LEFT JOIN warehouse w ON i.warehouse_id = w.warehouse_id
	    LEFT JOIN product p ON i.product_id = p.product_id
	    LEFT JOIN client c ON i.client_id = c.client_id
	    WHERE 1=1
	    <if test="inType != null and inType != ''">
	        AND i.in_type = #{inType}
	    </if>
	    <if test="inStatus != null and inStatus != ''">
	        AND i.in_status = #{inStatus}
	    </if>
	    ORDER BY i.in_id DESC
	</select>
	
	<!-- 오늘 입고 건수 조회 -->
	<select id="getTodayInputCount" resultType="int">
	    SELECT NVL(COUNT(*), 0)
	    FROM input
	    WHERE in_id LIKE 'IN' || #{today} || '%'
	</select>
	
	<!-- 입고 등록 -->
	<insert id="insertInput" parameterType="map">
	    INSERT INTO input (
	        in_id, warehouse_id, product_id, client_id,
	        manage_id, in_count, emp_id, lot_id, 
	        in_status, location_id, in_type
	    ) VALUES (
	        #{inId}, #{warehouseId}, #{productId}, #{clientId},
	        #{manageId}, #{inCount}, #{empId}, #{lotId},
	        #{inStatus}, #{locationId}, #{inType}
	    )
	</insert>
	
	<!-- 입고 상세 조회 -->
	<select id="selectInputById" resultType="map">
	    SELECT * FROM input WHERE in_id = #{inId}
	</select>
	
	<!-- 입고 상태 업데이트 -->
	<update id="updateInputStatus">
	    UPDATE input 
	    SET in_status = #{status},
	        in_complete = SYSDATE,
	        update_date = SYSDATE
	    WHERE in_id = #{inId}
	</update>
	
	<!-- 재고 증가 -->
	<update id="increaseStock">
	    UPDATE warehouse_item 
	    SET item_amount = item_amount + #{inCount},
	        update_date = SYSDATE
	    WHERE warehouse_id = #{warehouseId}
	    AND product_id = #{productId}
	    AND location_id = #{locationId}
	</update>
	
	<!-- 부품 목록 조회 -->
	<select id="selectPartsList" resultType="map">
	    SELECT 
	        product_id as "productId",
	        product_name as "productName"
	    FROM product
	    WHERE product_type = '부품'
	    ORDER BY product_name
	</select>
	
	<!-- 거래처 목록 조회 -->
	<select id="selectClientsList" resultType="map">
	    SELECT 
	        client_id as "clientId",
	        client_name as "clientName"
	    FROM client
	    WHERE client_status = 'Y'
	    ORDER BY client_name
	</select>
	
	<!-- 창고 타입별 조회 -->
	<select id="selectWarehouseListByType" resultType="com.erp_mes.mes.stock.dto.WarehouseDTO">
	    SELECT 
	        warehouse_id as warehouseId,
	        warehouse_name as warehouseName
	    FROM warehouse
	    WHERE warehouse_type = #{warehouseType}
	    AND warehouse_status = 'Y'
	    ORDER BY warehouse_name
	</select>
    
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.erp_mes.mes.business.mapper.BusinessMapper">
<!-- 전체 orders 개수 가져오기 -->
  <select id="countOrders" resultType="int">
  		SELECT 
  			COUNT(*)
  		FROM 
  			orders
  </select>
  
<!-- clientId 조회 (client_name 기준) -->
  <select id="findClientIdByName" parameterType="string" resultType="string">
    SELECT client_id FROM client WHERE client_name = #{clientName, jdbcType=VARCHAR}
  </select>

<!-- 주문(orders) insert -->
  <insert id="insertOrder" parameterType="map">
  		INSERT INTO orders (
        	order_id, 
        	client_id, 
        	client_name, 
        	emp_id, 
        	emp_name, 
        	order_date,
        	order_status, 
        	delivery_date, 
        	order_qty, 
        	order_price, 
        	update_at
   		) VALUES (
        	#{orderId},
        	#{clientId}, 
        	#{clientName, jdbcType=VARCHAR},
        	#{empId}, 
        	#{empName}, 
        	SYSDATE,
        	'RECEIVED', 
        	#{deliveryDate, jdbcType=DATE}, 
        	#{orderQty,}, 
        	#{orderPrice}, 
        	SYSDATE
    )
	</insert>

<!-- 주문 상세 (orders_detail) insert -->
  <insert id="insertOrderDetail" parameterType="map">
    	INSERT INTO orders_detail (
    		order_id,
    		id,
    		product_id,
    		product_name,
    		unit,
    		order_qty,
    		order_price,
    		create_at,
    		update_at
    	) VALUES (
    		#{orderId},
    		#{seqId},
    		#{productId},
    		#{productName},
    		#{unit},
    		#{orderQty},
    		#{orderPrice},
    		SYSDATE,
    		SYSDATE
    )
  </insert>

<!-- 	수주 등록 모달창에 필요한 품목 리스트 -->
	<select id="getAllProduct" resultType="com.erp_mes.mes.pm.dto.ProductDTO">
		SELECT 
			product_id,
			product_name,
			unit,
			price
		FROM   
			product
	</select>

<!-- 	수주 목록 전체 조회 -->
	<select id="getAllOrder" resultType="com.erp_mes.mes.business.dto.OrderDTO">
		SELECT 
			order_id,
			order_date,
			order_status,
			client_id,
			client_name,
			order_qty,
			order_price,
			delivery_date,
			emp_id,
			emp_name
		FROM 
		 	orders
	</select>

<!-- 	수주 상세 목록 조회 -->
	<select id="getOrderDetailsByOrderId" resultType="com.erp_mes.mes.business.dto.OrderDetailDTO">
	    SELECT
	    	id,
	    	order_id,
			product_id,
           	product_name,					
            order_price,
            unit,
            order_qty,
            (order_qty * order_price) AS total_price
        FROM
            orders_detail 
        WHERE
            order_id = #{orderId}
	</select>
		
</mapper>
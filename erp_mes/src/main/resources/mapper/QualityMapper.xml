<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.erp_mes.mes.quality.mapper.QualityMapper">

	<insert id="insertItem" parameterType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
	    <selectKey keyProperty="itemId" resultType="long" order="BEFORE">
	        SELECT INSPECTION_ITEM_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO INSPECTION_ITEM
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	        ITEM_ID,
	        <if test="materialId != null and materialId != ''">MATERIAL_ID,</if>
	        <if test="proId != null and proId != ''">PRO_ID,</if>
	        INSPECTION_FM_ID,
	        TOLERANCE_VALUE,
	        UNIT,
	    </trim>
	    <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
	        #{itemId},
	        <if test="materialId != null and materialId != ''">#{materialId},</if>
	        <if test="proId != null and proId != ''">#{proId},</if>
	        #{inspectionFMId},
	        #{toleranceValue},
	        #{unit},
	    </trim>
	</insert>

	<select id="findAllItems" resultType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
	    SELECT
	        T1.ITEM_ID,
	        T1.MATERIAL_ID AS materialId,
	        T1.PRO_ID AS proId,
	        T1.INSPECTION_FM_ID,
	        T1.TOLERANCE_VALUE,
	        T1.UNIT,
	        T2.INSPECTION_TYPE AS inspectionType,
	        T2.ITEM_NAME AS itemName,
	        T2.METHOD_NAME AS methodName
	    FROM INSPECTION_ITEM T1
	    JOIN INSPECTION_FM T2 ON T1.INSPECTION_FM_ID = T2.INSPECTION_FM_ID
	</select>

	<select id="findUnits"
		resultType="com.erp_mes.erp.commonCode.dto.CommonDetailCodeDTO">
		SELECT
		COM_DT_ID AS comDtId,
		COM_DT_NM AS comDtNm
		FROM COMMON_DT_CODE
		WHERE COM_ID = 'UNIT'
	</select>
	
    <update id="updateInspectionFm" parameterType="com.erp_mes.mes.quality.dto.InspectionFMDTO">
        UPDATE INSPECTION_FM
        SET
            INSPECTION_TYPE = #{inspectionType},
            ITEM_NAME = #{itemName},
            METHOD_NAME = #{methodName}
        WHERE
            INSPECTION_FM_ID = #{inspectionFMId}
    </update>

    <update id="updateInspectionItem" parameterType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
        UPDATE INSPECTION_ITEM
        SET
            INSPECTION_FM_ID = #{inspectionFMId},
            TOLERANCE_VALUE = #{toleranceValue},
            UNIT = #{unit},
            <if test="materialId != null">MATERIAL_ID = #{materialId},</if>
            <if test="materialId == null">MATERIAL_ID = NULL,</if>
            <if test="proId != null">PRO_ID = #{proId}</if>
            <if test="proId == null">PRO_ID = NULL</if>
        WHERE
            ITEM_ID = #{itemId}
    </update>

	<delete id="deleteItems">
		DELETE FROM INSPECTION_ITEM
		WHERE ITEM_ID IN
		<foreach collection="itemIds" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>

	<select id="getInspectionResultList"
		resultType="com.erp_mes.mes.quality.dto.InspectionResultDTO">
		SELECT
		T1.RESULT_ID AS resultId,
		T1.INSPECTION_ID AS inspectionId,
		T1.ITEM_ID AS itemId,
		T1.RESULT AS result,
		T1.REMARKS AS remarks,
		T2.INSPECTION_TYPE AS inspectionType,
		T2.PRODUCT_ID AS productId,
		T2.PROCESS_ID AS processId,
		T2.INSPECTION_DATE AS inspectionDate,
		T2.EMP_ID AS empId,
		T2.LOT_ID AS lotId,

		T3.COM_DT_NM AS inspectionTypeName,
		T4.PRO_NM AS processName,
		T5.PRODUCT_NAME AS productName,
		T6.EMP_NAME AS empName
		FROM INSPECTION_RESULT T1
		JOIN INSPECTION T2 ON T1.INSPECTION_ID =
		T2.INSPECTION_ID
		JOIN COMMON_DT_CODE T3 ON T2.INSPECTION_TYPE =
		T3.COM_DT_ID AND T3.COM_ID = 'QC'
		JOIN PROCESS T4 ON T2.PROCESS_ID =
		T4.PRO_ID
		JOIN PRODUCT T5 ON T2.PRODUCT_ID = T5.PRODUCT_ID
		JOIN EMPLOYEE
		T6 ON T2.EMP_ID = T6.EMP_ID
		ORDER BY T2.INSPECTION_DATE DESC
	</select>

<select id="findInCountByInId" parameterType="Long" resultType="Integer">
    SELECT IN_COUNT FROM INPUT WHERE IN_ID = #{inId}
</select>

<update id="updateInputStatusByInId">
    UPDATE INPUT
    SET IN_STATUS = #{newStatus}
    WHERE IN_ID = #{inId}
</update>

<insert id="insertInspection" parameterType="com.erp_mes.mes.quality.dto.InspectionDTO">
    <selectKey keyProperty="inspectionId" resultType="long" order="BEFORE">
        SELECT INSPECTION_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO INSPECTION (
        INSPECTION_ID, INSPECTION_TYPE, INSPECTION_DATE, EMP_ID, LOT_ID
    ) VALUES (
        #{inspectionId}, #{inspectionType}, SYSDATE, #{empId}, #{lotId}
    )
</insert>

<insert id="insertInspectionResult" parameterType="com.erp_mes.mes.quality.dto.InspectionResultDTO">
    INSERT INTO INSPECTION_RESULT (
        RESULT_ID, INSPECTION_ID, RESULT, REMARKS
    ) VALUES (
        INSPECTION_RESULT_SEQ.NEXTVAL, #{inspectionId}, #{result}, #{remarks}
    )
</insert>

<select id="getIncomingInspectionTargets" resultType="com.erp_mes.mes.quality.dto.InspectionTargetDTO">
    SELECT
        T1.IN_ID AS targetId,
        T2.MATERIAL_NAME AS targetName,
        T1.LOT_ID AS lotId,
        T1.IN_COUNT AS quantity,
        T3.INSPECTION_TYPE AS inspectionType,
        'Incoming' AS targetSource,  T1.IN_STATUS AS remarks,
        T2.MATERIAL_ID AS materialId
    FROM INPUT T1
    LEFT JOIN MATERIAL T2 ON T1.MATERIAL_ID = T2.MATERIAL_ID
    LEFT JOIN INSPECTION_FM T3 ON T2.INSPECTION_FM_ID = T3.INSPECTION_FM_ID
    WHERE T1.IN_STATUS = '입고대기' AND T1.MATERIAL_ID IS NOT NULL
</select>

<select id="getProcessInspectionTargets" resultType="com.erp_mes.mes.quality.dto.InspectionTargetDTO">
    SELECT
        T1.WORK_ORDER_ID AS targetId,
        T4.PRODUCT_NAME AS targetName,
        T1.LOT_ID AS lotId,
        T2.PLAN_QUANTITY AS quantity,
        T7.INSPECTION_TYPE AS inspectionType,
        'WorkOrder' AS targetSource,  T1.WORK_ORDER_STATUS AS remarks,
        T3.PRODUCT_ID AS productId,
        T3.PRO_ID AS processId,
        T1.EMP_ID AS empId
    FROM WORK_ORDER T1
    LEFT JOIN PRODUCT_PLAN T2 ON T1.PLAN_ID = T2.PLAN_ID
    LEFT JOIN PROCESS_ROUTING T3 ON T1.ROUTE_ID = T3.ROUTE_ID
    LEFT JOIN PRODUCT T4 ON T3.PRODUCT_ID = T4.PRODUCT_ID
    LEFT JOIN PROCESS T5 ON T3.PRO_ID = T5.PRO_ID
    LEFT JOIN INSPECTION_FM T7 ON T5.INSPECTION_FM_ID = T7.INSPECTION_FM_ID
    WHERE T1.WORK_ORDER_STATUS = '검사대기'
</select>

<select id="getPackagingInspectionTargets" resultType="com.erp_mes.mes.quality.dto.InspectionTargetDTO">
    SELECT
        T1.WORK_ORDER_ID AS targetId,
        T4.PRODUCT_NAME AS targetName,
        T1.LOT_ID AS lotId,
        T2.PLAN_QUANTITY AS quantity,
        T7.INSPECTION_TYPE AS inspectionType,
        'WorkOrder' AS targetSource,  T1.WORK_ORDER_STATUS AS remarks,
        T3.PRODUCT_ID AS productId,
        T3.PRO_ID AS processId,
        T1.EMP_ID AS empId
    FROM WORK_ORDER T1
    LEFT JOIN PRODUCT_PLAN T2 ON T1.PLAN_ID = T2.PLAN_ID
    LEFT JOIN PROCESS_ROUTING T3 ON T1.ROUTE_ID = T3.ROUTE_ID
    LEFT JOIN PRODUCT T4 ON T3.PRODUCT_ID = T4.PRODUCT_ID
    LEFT JOIN PROCESS T5 ON T3.PRO_ID = T5.PRO_ID
    LEFT JOIN INSPECTION_FM T7 ON T5.INSPECTION_FM_ID = T7.INSPECTION_FM_ID
    WHERE T1.WORK_ORDER_STATUS = '포장검사'
</select>
	
<select id="findInspectionItemsByMaterialId"
    parameterType="Long"
    resultType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
    SELECT
        T1.ITEM_ID,
        T1.TOLERANCE_VALUE,
        T1.UNIT,
        T2.ITEM_NAME,
        T2.METHOD_NAME,
        T2.INSPECTION_TYPE AS inspectionType,
        T3.SPEC AS standardValue 
    FROM INSPECTION_ITEM T1
    LEFT JOIN INSPECTION_FM T2 ON T1.INSPECTION_FM_ID = T2.INSPECTION_FM_ID
    LEFT JOIN MATERIAL T3 ON T1.MATERIAL_ID = T3.MATERIAL_ID
    WHERE T1.MATERIAL_ID = #{materialId}
</select>
	
<select id="findInspectionItemsByProcessId"
    parameterType="Long"
    resultType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
    SELECT
        T1.ITEM_ID,
        T1.TOLERANCE_VALUE,
        T1.UNIT,
        T2.ITEM_NAME,
        T2.METHOD_NAME,
        T2.INSPECTION_TYPE AS inspectionType,
        T4.SPEC AS standardValue
    FROM INSPECTION_ITEM T1
    LEFT JOIN INSPECTION_FM T2 ON T1.INSPECTION_FM_ID = T2.INSPECTION_FM_ID
    LEFT JOIN PROCESS_ROUTING T3 ON T1.PRO_ID = T3.PRO_ID
    LEFT JOIN PRODUCT T4 ON T3.PRODUCT_ID = T4.PRODUCT_ID
    WHERE T1.PRO_ID = #{processId}
</select>

	<update id="updateWorkOrderStatus" parameterType="String">
		UPDATE work_order
		SET work_order_status = '작업완료'
		WHERE work_order_id = #{workOrderId}
	</update>

</mapper>
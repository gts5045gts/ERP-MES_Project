<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.erp_mes.mes.quality.mapper.QualityMapper">

	<insert id="insertItem"
		parameterType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
		INSERT INTO INSPECTION_ITEM (
		ITEM_ID,
		PRODUCT_ID,
		INSPECTION_FM_ID,
		TOLERANCE_VALUE,
		UNIT
		)
		VALUES (
		INSPECTION_ITEM_SEQ.NEXTVAL,
		#{productId},
		#{inspectionFMId},
		#{toleranceValue},
		#{unit}
		)
	</insert>

	<select id="findAllItems"
		resultType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
		SELECT
			T1.ITEM_ID,
			T1.PRODUCT_ID AS productId,
			T1.INSPECTION_FM_ID,
			T1.TOLERANCE_VALUE,
			T1.UNIT,
			T2.INSPECTION_TYPE AS inspectionType,
			T2.ITEM_NAME AS itemName,
			T2.METHOD_NAME AS methodName
		FROM INSPECTION_ITEM T1
		JOIN INSPECTION_FM T2
		ON T1.INSPECTION_FM_ID = T2.INSPECTION_FM_ID
	</select>

	<select id="findUnits"
		resultType="com.erp_mes.erp.commonCode.dto.CommonDetailCodeDTO">
		SELECT
			COM_DT_ID AS comDtId,
			COM_DT_NM AS comDtNm
		FROM COMMON_DT_CODE
		WHERE COM_ID = 'UNIT'
	</select>

	<delete id="deleteItems">
		DELETE FROM INSPECTION_ITEM
		WHERE ITEM_ID IN
		<foreach collection="itemIds" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>
	
<!-- 검사완료이력 리스트 -->
	<select id="getInspectionResultList"
		resultType="com.erp_mes.mes.quality.dto.InspectionResultDTO">
		SELECT
			T1.RESULT_ID AS resultId,
			T1.INSPECTION_ID AS inspectionId,
			T1.ITEM_ID AS itemId,
			T1.RESULT AS result,
			T1.REMARKS AS remarks,
			T2.INSPECTION_TYPE AS inspectionType,
			T2.PRODUCT_ID AS productId,
			T2.PROCESS_ID AS processId,
			T2.INSPECTION_DATE AS inspectionDate,
			T2.EMP_ID AS empId,
			T2.LOT_ID AS lotId,
			
			T3.COM_DT_NM AS inspectionTypeName,  
			T4.PRO_NM AS processName,          
			T5.PRODUCT_NAME AS productName,      
			T6.EMP_NAME AS empName               
		FROM INSPECTION_RESULT T1
		JOIN INSPECTION T2 ON T1.INSPECTION_ID = T2.INSPECTION_ID
		JOIN COMMON_DT_CODE T3 ON T2.INSPECTION_TYPE = T3.COM_DT_ID AND T3.COM_ID = 'QC'
		JOIN PROCESS T4 ON T2.PROCESS_ID = T4.PRO_ID
		JOIN PRODUCT T5 ON T2.PRODUCT_ID = T5.PRODUCT_ID
		JOIN EMPLOYEE T6 ON T2.EMP_ID = T6.EMP_ID
		ORDER BY T2.INSPECTION_DATE DESC
	</select>
	
	<!--검사 대기 목록 -->
<select id="getInspectionTargets" resultType="com.erp_mes.mes.pm.dto.WorkOrderDTO">
    SELECT
        T1.WORK_ORDER_ID AS workOrderId,
        T1.WORK_ORDER_STATUS AS workOrderStatus,
        T1.LOT_ID AS lotId,
        T1.EMP_ID AS empId,
        T2.PLAN_QUANTITY AS planQuantity,
        T3.PRO_ID AS processId,
        T3.PRODUCT_ID AS productId,
        T4.PRODUCT_NAME AS productName,
        T5.PRO_NM AS processName,
        T6.EMP_NAME AS empName,
        T7.INSPECTION_TYPE AS inspectionType,
        T8.COM_DT_NM AS inspectionTypeName
    FROM WORK_ORDER T1
    LEFT JOIN PRODUCT_PLAN T2 ON T1.PLAN_ID = T2.PLAN_ID
    LEFT JOIN PROCESS_ROUTING T3 ON T1.ROUTE_ID = T3.ROUTE_ID
    LEFT JOIN PRODUCT T4 ON T3.PRODUCT_ID = T4.PRODUCT_ID
    LEFT JOIN PROCESS T5 ON T3.PRO_ID = T5.PRO_ID
    LEFT JOIN EMPLOYEE T6 ON T1.EMP_ID = T6.EMP_ID
    LEFT JOIN INSPECTION_FM T7 ON T5.TYPE_NM = T7.INSPECTION_TYPE LEFT JOIN COMMON_DT_CODE T8 ON T7.INSPECTION_TYPE = T8.COM_DT_ID AND T8.COM_ID = 'QC'
    WHERE T1.WORK_ORDER_STATUS IN ('대기중', '검사대기')
</select>

<!-- 검사기준 조회 -->
<select id="findInspectionItemsByProductId" parameterType="String" resultType="com.erp_mes.mes.quality.dto.InspectionItemDTO">
    SELECT
        T1.ITEM_ID AS itemId,
        T1.PRODUCT_ID AS productId,
        T1.INSPECTION_FM_ID AS inspectionFMId,
        T1.TOLERANCE_VALUE AS toleranceValue,
        T1.UNIT AS unit,
        T2.INSPECTION_TYPE AS inspectionType,
        T2.ITEM_NAME AS itemName
    FROM INSPECTION_ITEM T1
    JOIN INSPECTION_FM T2 ON T1.INSPECTION_FM_ID = T2.INSPECTION_FM_ID
    WHERE T1.PRODUCT_ID = #{productId}
</select>

<insert id="insertInspection" parameterType="com.erp_mes.mes.quality.dto.InspectionDTO">
    <selectKey keyProperty="inspectionId" resultType="long" order="BEFORE">
        SELECT INSPECTION_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO INSPECTION (
        INSPECTION_ID, INSPECTION_TYPE, PRODUCT_ID, PROCESS_ID,
        INSPECTION_DATE, EMP_ID, LOT_ID
    ) VALUES (
        #{inspectionId}, #{inspectionType}, #{productId}, #{processId},
        SYSDATE, #{empId}, #{lotId}
    )
</insert>

<!-- 검사결과 저장 -->
<insert id="insertInspectionResult" parameterType="com.erp_mes.mes.quality.dto.InspectionResultDTO">
    INSERT INTO INSPECTION_RESULT (
        RESULT_ID, INSPECTION_ID, ITEM_ID, RESULT, REMARKS
    ) VALUES (
        INSPECTION_RESULT_SEQ.NEXTVAL, #{inspectionId}, #{itemId}, #{result}, #{remarks}
    )
</insert>

<update id="updateWorkOrderStatus" parameterType="String">
    UPDATE work_order
    SET work_order_status = '작업완료'
    WHERE work_order_id = #{workOrderId}
</update>



</mapper>
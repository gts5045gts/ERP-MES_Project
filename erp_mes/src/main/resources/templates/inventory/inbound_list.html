<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">입고 관리</h1>
	    <div class="card shadow mb-4">
	        <div class="card-header py-3">
	            <ul class="nav nav-tabs card-header-tabs">
	                <li class="nav-item">
	                    <a class="nav-link active" id="material-tab" data-toggle="tab" href="#material-content">
	                        부품/반제품 입고
	                    </a>
	                </li>
	                <li class="nav-item">
	                    <a class="nav-link" id="product-tab" data-toggle="tab" href="#product-content">
	                        완제품 입고
	                    </a>
	                </li>
	            </ul>
	        </div>
	        
	        <!-- 탭 컨텐츠 -->
	        <div class="card-body">
	            <div class="tab-content">
	                <!-- 부품/반제품 탭 -->
	                <div class="tab-pane fade show active" id="material-content">
	                    <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addInputModal">
	                        <i class="fas fa-plus"></i> 신규 입고
	                    </button>
	                    
	                    <div class="table-responsive">
	                    </div>
	                </div>
	                
	                <!-- 완제품 탭 -->
	                <div class="tab-pane fade" id="product-content">
					    <button class="btn btn-success mb-3" onclick="openProductInputModal()">
					        <i class="fas fa-plus"></i> 완제품 입고 등록
					    </button>
					    <div class="table-responsive">
					    </div>
					</div>
	            </div>
	        </div>
	    </div>
	</div>
    
    <!-- 상세 내역 모달 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalTitle">입고 상세 내역</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive" id="detailTableWrapper">
                        <table class="table table-bordered" id="detailTable">
                            <thead>
                                <tr>
                                    <th>입고ID</th>
                                    <th>거래처</th>
                                    <th>자재명</th>
                                    <th>구분</th>
                                    <th>수량</th>
                                    <th>위치(구역)</th>
                                    <th>담당자</th>
                                    <th>상태</th>
                                    <th>검사</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-info" onclick="exportDetailPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-success" onclick="exportDetailExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 부품입고 모달 -->
    <div class="modal fade" id="addInputModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">신규 입고 등록 (부품/반제품)</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>입고담당자</label>
                            <input type="text" class="form-control" id="currentEmpInfo" readonly>
                        </div>
                        <div class="col-md-6">
                            <label>입고타입</label>
                            <select class="form-control" id="new_inType">
                                <option value="정기입고">정기입고</option>
                                <option value="긴급입고">긴급입고</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>거래처</label>
                            <select class="form-control" id="new_clientId">
                                <!-- Ajax로 로드 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>창고</label>
                            <select class="form-control" id="new_warehouseId">
                                <option th:each="warehouse : ${warehouseList}" 
                                        th:value="${warehouse.warehouseId}"
                                        th:text="${warehouse.warehouseName}">
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>자재 목록 (부품/반제품만 입고 가능)</h6>
                        <button type="button" class="btn btn-sm btn-info" onclick="addMaterialRow()">
                            <i class="fas fa-plus"></i> 자재 추가
                        </button>
                    </div>
                    
                    <div id="materialsList">
                        <div class="material-item mb-2">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control material-select">
                                        <!-- Ajax로 로드 -->
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control material-qty" placeholder="수량" min="1">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger btn-sm remove-material" onclick="removeMaterialRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        선택한 자재: <span id="selectedMaterialCount">0</span>종
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveInput()">등록</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 완제품 입고 모달 -->
	<div class="modal fade" id="productInputModal" tabindex="-1">
	    <div class="modal-dialog modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title">완제품 입고 등록</h5>
	                <button type="button" class="close" data-dismiss="modal">
	                    <span>&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <div class="row mb-3">
	                    <div class="col-md-6">
	                        <label>입고담당자</label>
	                        <input type="text" class="form-control" id="product_emp_info" readonly>
	                    </div>
	                    <div class="col-md-6">
	                        <label>완제품 창고</label>
	                        <select class="form-control" id="product_warehouse">
	                        </select>
	                    </div>
	                </div>
	                
	                <hr>
	                
	                <div class="d-flex justify-content-between align-items-center mb-3">
	                    <h6>완제품 목록</h6>
	                    <button type="button" class="btn btn-sm btn-info" onclick="addProductRow()">
	                        <i class="fas fa-plus"></i> 제품 추가
	                    </button>
	                </div>
	                
	                <div id="productsList">
	                    <div class="product-item mb-2">
	                        <div class="row">
	                            <div class="col-md-7">
	                                <select class="form-control product-select">
	                                    <option value="">선택하세요</option>
	                                </select>
	                            </div>
	                            <div class="col-md-3">
	                                <input type="number" class="form-control product-qty" placeholder="수량" min="1">
	                            </div>
	                            <div class="col-md-2">
	                                <button class="btn btn-danger btn-sm remove-product" onclick="removeProductRow(this)" style="display:none;">
	                                    <i class="fas fa-trash"></i>
	                                </button>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                
	                <div class="alert alert-info mt-3">
	                    선택한 완제품: <span id="selectedProductCount">0</span>종
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
	                <button type="button" class="btn btn-success" onclick="saveProductBatch()">입고 등록</button>
	            </div>
	        </div>
	    </div>
	</div>
</th:block>

<th:block layout:fragment="script">
<script>
let materialsData = [];
let currentBatchId = '';
let currentInType = '';
let currentUser = {};
let productsData = [];

//탭 클릭 이벤트 직접 등록
$(document).ready(function() {
    getCurrentUser();
    loadGroupedInputList();
    loadMaterials();
    loadClients();
    
    // 부트스트랩 탭 이벤트 리스너
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        
        if(target === "#product-content") {
            // 완제품 탭 활성화되면 데이터 로드
            $.ajax({
                url: '/inventory/api/inputs/grouped',
                type: 'GET',
                success: function(data) {
                    const productData = data.filter(item => item.inType === '생산완료');
                    
                    let html = `
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>입고 내역</th>
                                    <th>구분</th>
                                    <th>수량</th>
                                    <th>담당자</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    if(productData.length === 0) {
                        html += `<tr><td colspan="5" class="text-center">완제품 입고 내역이 없습니다.</td></tr>`;
                    } else {
                        productData.forEach(group => {
                            html += `
                                <tr>
                                    <td>${group.inDate} ${group.inTime} 생산완료</td>
                                    <td><span class="badge badge-success">생산완료</span></td>
                                    <td>${group.totalCount}건 (총 ${group.totalQty}개)</td>
                                    <td>${group.empName}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="showDetail('${group.batchId}', '생산완료')">
                                            내역확인
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += '</tbody></table>';
                    $('#product-content .table-responsive').html(html);
                }
            });
        }
    });
});

//탭 전환 시 데이터 로드 부분 확인
$('#material-tab').on('shown.bs.tab', function (e) {
    loadGroupedInputList();  // 부품/반제품 그룹화된 목록
});

$('#product-tab').on('shown.bs.tab', function (e) {
    loadProductInputList();  // 완제품 목록
});

$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    const target = $(e.target).attr("href");
    console.log("탭 전환됨:", target);
    
    if(target === "#product-content") {
        console.log("완제품 탭 활성화!");
        
        // 바로 API 호출
        $.ajax({
            url: '/inventory/api/inputs/grouped',
            type: 'GET',
            success: function(data) {
                console.log("API 응답:", data);
                
                // 생산완료만 필터
                const productData = data.filter(item => item.inType === '생산완료');
                console.log("생산완료 데이터:", productData);
                
                // HTML 생성
                let html = '<table class="table"><thead><tr><th>테스트</th></tr></thead><tbody>';
                if(productData.length > 0) {
                    html += '<tr><td>생산완료 데이터 ' + productData.length + '건 있음</td></tr>';
                } else {
                    html += '<tr><td>생산완료 데이터 없음</td></tr>';
                }
                html += '</tbody></table>';
                
                $('#product-content .table-responsive').html(html);
            },
            error: function(xhr) {
                console.error("API 에러:", xhr);
            }
        });
    }
});


//완제품 입고 모달 열기
function openProductInputModal() {
    $('#product_emp_info').val(currentUser.empId + ' - ' + currentUser.empName);
    loadProducts();  
    loadProductWarehouses();
    $('#productInputModal').modal('show');
}

//모든 product select 업데이트
function updateAllProductSelects() {
    $('.product-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        productsData.forEach(item => {
            $(this).append(`<option value="${item.productId}">${item.productName}</option>`);
        });
        
        if(currentValue) {
            $(this).val(currentValue);
        }
    });
    updateSelectedProductCount();
}

//완제품 행 삭제
function removeProductRow(btn) {
    $(btn).closest('.product-item').remove();
    
    if($('.product-item').length === 1) {
        $('.remove-product').hide();
    }
    updateSelectedProductCount();
}

// 선택한 완제품 수 업데이트
function updateSelectedProductCount() {
    let count = 0;
    $('.product-select').each(function() {
        if($(this).val()) {
            count++;
        }
    });
    $('#selectedProductCount').text(count);
}

//부품/반제품 입고 목록 로드
function loadMaterialInputList() {
    $.ajax({
        url: '/inventory/api/inputs?itemType=material',
        type: 'GET',
        success: function(data) {
        	console.log("받은 데이터:", data);
            // 부품/반제품 목록 렌더링
            renderMaterialTable(data);
        },
        error: function(xhr, status, error) {
            console.error("에러 발생:", error);
        }
    });
}

//완제품 창고 로드
function loadProductWarehouses() {
    $.ajax({
        url: '/inventory/api/warehouses?warehouseType=완제품',
        type: 'GET',
        success: function(data) {
            const select = $('#product_warehouse');
            select.empty();
            
            if(data.length === 0) {
                select.append('<option value="">완제품 창고가 없습니다</option>');
                alert('완제품 창고를 먼저 등록하세요!');
            } else {
                data.forEach(warehouse => {
                    select.append(`<option value="${warehouse.warehouseId}">${warehouse.warehouseName}</option>`);
                });
            }
        }
    });
}

//완제품 그룹 목록만 로드하는 새 함수
function loadProductGroupedList() {
    $.ajax({
        url: '/inventory/api/inputs/grouped',
        type: 'GET',
        success: function(data) {
            console.log("받은 데이터:", data);
            
            // 생산완료 타입 필터링
            const productData = data.filter(item => item.inType === '생산완료');
            console.log("생산완료 데이터:", productData);
            
            // 완제품 탭의 table-responsive에 테이블 생성
            let html = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>입고 내역</th>
                            <th>구분</th>
                            <th>수량</th>
                            <th>담당자</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if(productData.length === 0) {
                html += `
                    <tr>
                        <td colspan="5" class="text-center">
                            완제품 입고 내역이 없습니다.<br>
                            <small class="text-muted">위 버튼으로 완제품을 입고하세요.</small>
                        </td>
                    </tr>
                `;
            } else {
                productData.forEach(group => {
                    const dateStr = group.inDate || '';
                    const timeStr = group.inTime || '';
                    
                    html += `
                        <tr>
                            <td>${dateStr} ${timeStr} 생산완료 입고</td>
                            <td><span class="badge badge-success">생산완료</span></td>
                            <td>${group.totalCount}건 (총 ${group.totalQty || 0}개)</td>
                            <td>${group.empName || group.empId || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" 
                                        onclick="showDetail('${group.batchId}', '생산완료')">
                                    내역확인
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            
            // 완제품 탭의 table-responsive에 삽입
            $('#product-content .table-responsive').html(html);
        },
        error: function(xhr) {
            console.error("데이터 로드 실패:", xhr);
            $('#product-content .table-responsive').html(
                '<div class="alert alert-danger">데이터 로드 실패</div>'
            );
        }
    });
}

//부품/반제품 테이블 렌더링
function renderMaterialTable(data) {
    const container = $('#material-input-list');
    
    let html = `
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>입고번호</th>
                        <th>자재명</th>
                        <th>창고</th>
                        <th>수량</th>
                        <th>상태</th>
                        <th>입고일</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="7" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(item => {
            html += `
                <tr>
                    <td>${item.inId}</td>
                    <td>${item.materialName || '-'}</td>
                    <td>${item.warehouseName}</td>
                    <td>${item.inCount}</td>
                    <td>
                        <span class="badge badge-${item.inStatus === '입고완료' ? 'success' : 'warning'}">
                            ${item.inStatus}
                        </span>
                    </td>
                    <td>${item.inComplete || '-'}</td>
                    <td>
                        ${item.inStatus === '입고대기' ? 
                            `<button class="btn btn-sm btn-primary" onclick="completeInput('${item.inId}')">
                                입고완료
                            </button>` : '-'}
                    </td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.html(html);
}

//완제품 목록 로드
function loadProducts() {
    $.ajax({
        url: '/inventory/api/products-for-input',  
        type: 'GET',
        success: function(data) {
            productsData = data;  // 전역 변수에 저장
            updateAllProductSelects();  // select 업데이트
        },
        error: function(xhr) {
            console.error("완제품 목록 로드 실패:", xhr);
        }
    });
}

//완제품 입고 저장
function saveProductInput() {
    const productId = $('#product_select').val();
    const qty = $('#product_qty').val();
    const warehouseId = $('#product_warehouse').val();
    
    if(!productId || !qty) {
        alert('제품과 수량을 입력하세요.');
        return;
    }
    
    if(!warehouseId) {
        alert('완제품 창고를 선택하세요.');
        return;
    }
    
    const data = {
        itemType: 'product',
        productId: productId,
        inCount: qty,
        warehouseId: warehouseId,
        clientId: 'SELF',  // 자체 생산
        inType: '생산완료',
        empId: currentUser.empId  // 현재 로그인한 사용자
    };
    
    $.ajax({
        url: '/inventory/api/inputs',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert('완제품 입고 완료! 창고에 즉시 반영되었습니다.');
                $('#productInputModal').modal('hide');
                $('#product_select').val('');
                $('#product_qty').val('');
                loadProductInputList();
            }
        }
    });
}

//완제품 행 추가
function addProductRow() {
    const newRow = `
        <div class="product-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-select" onchange="updateSelectedProductCount()">
                        <option value="">선택하세요</option>
                        ${productsData.map(item => 
                            `<option value="${item.productId}">${item.productName}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product" onclick="removeProductRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    $('#productsList').append(newRow);
    
    if($('.product-item').length > 1) {
        $('.remove-product').first().show();
    }
    updateSelectedProductCount();
}

// 완제품 테이블 렌더링 
function renderProductTable(data) {
    const container = $('#product-input-list');
    
    let html = `
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>입고번호</th>
                        <th>제품명</th>
                        <th>창고</th>
                        <th>수량</th>
                        <th>상태</th>
                        <th>입고일</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
    `;
    if(data.length === 0) {
        html += '<tr><td colspan="7" class="text-center">완제품 입고 데이터가 없습니다.</td></tr>';
    } else {
        // product_id가 있는 항목만 필터링
        const productData = data.filter(item => item.productId);
        
        if(productData.length === 0) {
            html += '<tr><td colspan="7" class="text-center">완제품 입고 데이터가 없습니다.</td></tr>';
        } else {
            productData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.inId}</td>
                        <td>${item.productName || '제품명 없음'}</td>
                        <td>${item.warehouseName}</td>
                        <td>${item.inCount}</td>
                        <td>
                            <span class="badge badge-${item.inStatus === '입고완료' ? 'success' : 'warning'}">
                                ${item.inStatus}
                            </span>
                        </td>
                        <td>${item.inComplete || '-'}</td>
                        <td>
                            ${item.inStatus === '입고대기' ? 
                                `<button class="btn btn-sm btn-primary" onclick="completeInput('${item.inId}')">
                                    입고완료
                                </button>` : '-'}
                        </td>
                    </tr>
                `;
            });
        }
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    container.html(html);
}

//완제품 입고 목록 로드
function loadProductInputList() {
    $.ajax({
        url: '/inventory/api/inputs/grouped',  
        type: 'GET',
        success: function(data) {
            console.log("완제품 그룹 데이터:", data);
            const productGroups = data.filter(item => item.inType === '생산완료');
            renderProductGroupedTable(productGroups);
        }
    });
}

//완제품 그룹 테이블 렌더링 함수 추가
function renderProductGroupedTable(data) {
    const container = $('#product-content .table-responsive');
    
    // 테이블 컨테이너가 없으면 생성
    if(container.length === 0) {
        $('#product-input-list').html('<div class="table-responsive"></div>');
    }
    
    let html = `
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>입고 내역</th>
                    <th>구분</th>
                    <th>수량</th>
                    <th>담당자</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="5" class="text-center">완제품 입고 내역이 없습니다.</td></tr>';
    } else {
        data.forEach(group => {
            html += `
                <tr>
                    <td>${group.inDate} ${group.inTime} 생산완료 입고</td>
                    <td><span class="badge badge-success">생산완료</span></td>
                    <td>${group.totalCount}건 (총 ${group.totalQty || 0}개)</td>
                    <td>${group.empName || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick="showDetail('${group.batchId}', '${group.inType}')">
                            내역확인
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    html += '</tbody></table>';
    $('#product-input-list').html(html);  
}

//페이지 로드 시 초기화
$(document).ready(function() {
    loadMaterialInputList(); 
});

// 현재 로그인 사용자 정보
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUser = data;
            $('#currentEmpInfo').val(data.empId + ' - ' + data.empName);
        }
    });
}

// 날짜별 그룹화된 입고 목록 로드 (담당자 포함)
function loadGroupedInputList() {
    $.ajax({
        url: '/inventory/api/inputs/grouped',
        success: function(data) {
            console.log("grouped 데이터:", data);
            renderGroupedTable(data);  
        }
    });
}

function renderGroupedTable(data) {
    // 탭 구조의 material-content 안에 테이블 추가
    const container = $('#material-content .table-responsive');
    
    let html = `
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>입고 내역</th>
                    <th>구분</th>
                    <th>수량</th>
                    <th>담당자</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="5" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(group => {
            const typeLabel = group.inType === '긴급입고' ? 
                '<span class="badge badge-danger">긴급입고</span>' : 
                '<span class="badge badge-info">정기입고</span>';
            
            html += `
                <tr>
                    <td>${group.inDate} ${group.inTime} ${group.inType} 내역입니다.</td>
                    <td>${typeLabel}</td>
                    <td>${group.totalCount}건 (총 ${group.totalQty || 0}개)</td>
                    <td>${group.empName || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick="showDetail('${group.batchId}', '${group.inType}')">
                            내역확인
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    html += `
            </tbody>
        </table>
    `;
    
    container.html(html);
}

// 그룹화된 목록 표시
function displayGroupedList(data) {
    const tbody = $('#groupedInputTableBody');
    tbody.empty();
    
    if(data.length === 0) {
        tbody.append('<tr><td colspan="5" class="text-center">데이터가 없습니다.</td></tr>');
        return;
    }
    
    data.forEach(group => {
        const date = new Date(group.inDate);
        const dateStr = `${date.getMonth()+1}월 ${date.getDate()}일`;
        const timeStr = group.inTime || '';
        const typeLabel = group.inType === '긴급입고' ? 
            '<span class="badge badge-danger">긴급입고</span>' : 
            '<span class="badge badge-info">정기입고</span>';
        
        tbody.append(`
            <tr>
                <td>${dateStr} ${timeStr} ${group.inType} 내역입니다.</td>
                <td>${typeLabel}</td>
                <td>${group.totalCount}건 (총 ${group.totalQty || 0}개)</td>
                <td>${group.empName || group.empId || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" 
                            onclick="showDetail('${group.batchId}', '${group.inType}')">
                        내역확인
                    </button>
                </td>
            </tr>
        `);
    });
}

// 상세 내역 보기
function showDetail(batchId, type) {
    currentBatchId = batchId;
    currentInType = type;
    
    $.ajax({
        url: '/inventory/api/inputs',
        type: 'GET',
        data: {
            batchId: batchId
        },
        success: function(data) {
            $('#detailModalTitle').text(`${type} 상세 내역`);
            
            const tbody = $('#detailTableBody');
            tbody.empty();
            
            data.forEach(item => {
                const statusBadge = item.inStatus === '입고완료' ? 
                    '<span class="badge badge-success">완료</span>' : 
                    '<span class="badge badge-warning">대기</span>';
                
                // 생산완료(완제품)인 경우 검사버튼 없음
                const inspectBtn = type === '생산완료' ? 
                    '<span class="text-success">✓</span>' :
                    (item.inStatus === '입고대기' ? 
                        `<button class="btn btn-sm btn-success" onclick="inspectOne('${item.inId}')">검사완료</button>` :
                        '<span class="text-success">✓</span>');
                
                // 제품명 표시 - 완제품이면 productName, 부품이면 materialName
                const itemName = item.productName || item.materialName || '-';
                
                // 구분 표시
                let itemType = '';
                if(item.productName) {
                    itemType = '<span class="badge badge-success">완제품</span>';
                } else if(item.materialType === '부품') {
                    itemType = '<span class="badge badge-info">부품</span>';
                } else if(item.materialType === '반제품') {
                    itemType = '<span class="badge badge-warning">반제품</span>';
                }
                
                const locationDisplay = item.inStatus === '입고완료' && item.locationId ? 
                    `<span class="badge badge-primary">${item.locationId.substring(0, 6)}</span>` :
                    '<span class="text-muted">미정</span>';
                
                tbody.append(`
                    <tr>
                        <td>${item.inId || '-'}</td>
                        <td>${item.clientName || '-'}</td>
                        <td>${itemName}</td>
                        <td>${itemType}</td>
                        <td>${item.inCount || 0}개</td>
                        <td class="location-col">${locationDisplay}</td>
                        <td>${item.empName || item.empId || '-'}</td>
                        <td class="status-col">${statusBadge}</td>
                        <td class="inspect-col">${inspectBtn}</td>
                        <td class="complete-time" style="display:none;">${item.completeTime || '-'}</td>
                    </tr>
                `);
            });
            $('#detailModal').modal('show');
        }
    });
}

//완제품 배치 저장
function saveProductBatch() {
    const items = [];
    const warehouseId = $('#product_warehouse').val();
    
    if(!warehouseId) {
        alert('완제품 창고를 선택하세요.');
        return;
    }
    
    $('.product-item').each(function() {
        const productId = $(this).find('.product-select').val();
        const qty = $(this).find('.product-qty').val();
        
        if(productId && qty) {
            items.push({
                itemType: 'product',
                productId: productId,
                inCount: qty,
                warehouseId: warehouseId,
                clientId: 'SELF',
                inType: '생산완료'
            });
        }
    });
    
    if(items.length === 0) {
        alert('최소 하나의 완제품을 선택하세요.');
        return;
    }
    
    // 배치로 전송
    $.ajax({
        url: '/inventory/api/inputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert('완제품 ' + items.length + '종 입고 완료! 창고에 즉시 반영되었습니다.');
                $('#productInputModal').modal('hide');
                resetProductForm();
                loadGroupedInputList();
                loadProductInputList();
            }
        },
        error: function(xhr) {
            alert('입고 등록 실패: ' + xhr.responseText);
        }
    });
}

//완제품 폼 초기화
function resetProductForm() {
    $('#productsList').html(`
        <div class="product-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-select" onchange="updateSelectedProductCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product" onclick="removeProductRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllProductSelects();
}

// 자재(부품/반제품) 목록 로드
function loadMaterials() {
    $.ajax({
        url: '/inventory/api/materials-for-input',
        type: 'GET',
        success: function(data) {
            materialsData = data;
            updateAllMaterialSelects();
        }
    });
}

// 자재 select 업데이트
function updateAllMaterialSelects() {
    $('.material-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        materialsData.forEach(item => {
            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
            $(this).append(`<option value="${item.materialId}">${typeLabel} ${item.materialName}</option>`);
        });
        
        if(currentValue) {
            $(this).val(currentValue);
        }
    });
    updateSelectedCount();
}

// 자재 행 추가
function addMaterialRow() {
    const newRow = `
        <div class="material-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-select" onchange="updateSelectedCount()">
                        <option value="">선택하세요</option>
                        ${materialsData.map(item => {
                            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
                            return `<option value="${item.materialId}">${typeLabel} ${item.materialName}</option>`
                        }).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material" onclick="removeMaterialRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    $('#materialsList').append(newRow);
    
    if($('.material-item').length > 1) {
        $('.remove-material').first().show();
    }
    updateSelectedCount();
}

// 자재 행 삭제
function removeMaterialRow(btn) {
    $(btn).closest('.material-item').remove();
    
    if($('.material-item').length === 1) {
        $('.remove-material').hide();
    }
    updateSelectedCount();
}

// 선택한 자재 수 업데이트
function updateSelectedCount() {
    let count = 0;
    $('.material-select').each(function() {
        if($(this).val()) {
            count++;
        }
    });
    $('#selectedMaterialCount').text(count);
}

// 거래처 목록 로드
function loadClients() {
    $.ajax({
        url: '/inventory/api/clients',
        type: 'GET',
        success: function(data) {
            const select = $('#new_clientId');
            select.empty();
            select.append('<option value="">선택하세요</option>');
            data.forEach(item => {
                select.append(`<option value="${item.clientId}">${item.clientName}</option>`);
            });
        }
    });
}

// 신규 입고 모달 표시
function showAddModal() {
    $('#addInputModal').modal('show');
}

// 입고 저장 (부품/반제품만)
function saveInput() {
    const items = [];
    
    $('.material-item').each(function() {
        const materialId = $(this).find('.material-select').val();
        const qty = $(this).find('.material-qty').val();
        
        if(materialId && qty) {
            items.push({
                inType: $('#new_inType').val(),
                productId: materialId,  // material_id를 product_id로 사용
                clientId: $('#new_clientId').val(),
                inCount: qty,
                warehouseId: $('#new_warehouseId').val()
            });
        }
    });
    
    if(items.length === 0) {
        alert('최소 하나의 자재를 선택하세요.');
        return;
    }
    
    if(!$('#new_clientId').val()) {
        alert('거래처를 선택하세요.');
        return;
    }
    
    // 배치로 한번에 전송
    $.ajax({
        url: '/inventory/api/inputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert(result.message);
                $('#addInputModal').modal('hide');
                resetInputForm();
                loadGroupedInputList();
            } else {
                alert('등록 실패: ' + result.message);
            }
        }
    });
}

// 폼 초기화
function resetInputForm() {
    $('#materialsList').html(`
        <div class="material-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-select" onchange="updateSelectedCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material" onclick="removeMaterialRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllMaterialSelects();
}

// 검사 완료
function inspectOne(inId) {
    if(confirm('이 항목을 검사 완료하시겠습니까?')) {
        $.ajax({
            url: `/inventory/api/inputs/${inId}/complete`,
            type: 'PUT',
            headers: {
                'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
            },
            success: function(result) {
                if(result.success) {
                    // 성공 메시지
                    alert('검사 완료! 재고가 반영되었습니다.');
                    
                    // 모달 내용만 다시 로드 (모달 닫지 않음)
                    refreshDetailModal();
                    
                    // 메인 리스트도 새로고침
                    loadGroupedInputList();
                } else {
                    alert('처리 실패: ' + (result.message || '알 수 없는 오류'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Ajax 오류:', status, error);
                alert('서버 오류가 발생했습니다.');
            }
        });
    }
}

// 검색
function searchInput() {
    loadGroupedInputList();
}

//PDF 출력
function exportDetailPDF() {
    const title = $('#detailModalTitle').text();
    
    // 테이블 헤더 변경
    $('#detailTable thead tr').html(`
        <th>입고ID</th>
        <th>거래처</th>
        <th>자재명</th>
        <th>구분</th>
        <th>수량</th>
        <th>위치</th>
        <th>담당자</th>
        <th>입고완료시간</th>
    `);
    
    // 테이블 바디
    $('#detailTable tbody tr').each(function() {
        $(this).find('.status-col').hide();
        $(this).find('.inspect-col').hide();
        $(this).find('.complete-time').show();
    });
    
    html2canvas(document.querySelector('#detailTableWrapper')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
        
        pdf.setFontSize(16);
        pdf.text(title, 15, 15);
        
        const imgWidth = 270;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 15, 25, imgWidth, imgHeight);
        pdf.save(`${title}.pdf`);
        
        
        $('#detailTable thead tr').html(`
            <th>입고ID</th>
            <th>거래처</th>
            <th>자재명</th>
            <th>구분</th>
            <th>수량</th>
            <th>위치</th>
            <th>담당자</th>
            <th>상태</th>
            <th>검사</th>
        `);
        
        $('#detailTable tbody tr').each(function() {
            $(this).find('.status-col').show();
            $(this).find('.inspect-col').show();
            $(this).find('.complete-time').hide();
        });
    });
}

//완제품 탭 클릭 시
$('#product-tab').on('shown.bs.tab', function (e) {
    loadProductSimpleList();
});

// 완제품 심플 리스트
function loadProductSimpleList() {
    $.ajax({
        url: '/api/inventory/products',
        type: 'GET',
        success: function(data) {
            let html = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="20%">제품코드</th>
                            <th width="40%">제품명</th>
                            <th width="20%">재고</th>
                            <th width="20%">작업</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if(data.length === 0) {
                html += '<tr><td colspan="4" class="text-center">완제품이 없습니다.</td></tr>';
            } else {
                data.forEach(product => {
                    html += `
                        <tr>
                            <td>${product.productId}</td>
                            <td><strong>${product.productName}</strong></td>
                            <td>${product.quantity || 0}개</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewProductDetail('${product.productId}')">
                                    상세
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            $('#product-content .table-responsive').html(html);
        }
    });
}

// Excel
function exportDetailExcel() {
    const title = $('#detailModalTitle').text();
    
    // 테이블 복사
    const tempTable = $('#detailTable').clone();
    
    // 헤더 변경
    tempTable.find('thead tr').html(`
        <th>입고ID</th>
        <th>거래처</th>
        <th>자재명</th>
        <th>구분</th>
        <th>수량</th>
        <th>위치</th>
        <th>담당자</th>
        <th>입고완료시간</th>
    `);
    
    // 바디 수정
    tempTable.find('tbody tr').each(function() {
        const completeTime = $(this).find('.complete-time').text();
        $(this).find('.status-col').remove();
        $(this).find('.inspect-col').remove();
        $(this).find('.complete-time').remove();
        $(this).append(`<td>${completeTime}</td>`);
    });
    
    const wb = XLSX.utils.table_to_book(tempTable[0], {sheet: "Sheet1"});
    XLSX.writeFile(wb, `${title}.xlsx`);
}

function refreshDetailModal() {
    $.ajax({
        url: '/inventory/api/inputs',
        type: 'GET',
        data: {
            batchId: currentBatchId
        },
        success: function(data) {
            const tbody = $('#detailTableBody');
            tbody.empty();
            
            data.forEach(item => {
                const statusBadge = item.inStatus === '입고완료' ? 
                    '<span class="badge badge-success">완료</span>' : 
                    '<span class="badge badge-warning">대기</span>';
                
                const inspectBtn = item.inStatus === '입고대기' ? 
                    `<button class="btn btn-sm btn-success" onclick="inspectOne('${item.inId}')">검사완료</button>` :
                    '<span class="text-success">✔</span>';
                
                const materialType = item.materialType === '부품' ? 
                    '<span class="badge badge-info">부품</span>' : 
                    '<span class="badge badge-warning">반제품</span>';
                
                // 위치 표시 - 전체 location_id의 앞 6자리만
                const locationDisplay = item.inStatus === '입고완료' && item.locationId ? 
                    `<span class="badge badge-primary">${item.locationId.substring(0, 6)}</span>` :
                    '<span class="text-muted">미정</span>';
                
                tbody.append(`
                    <tr>
                        <td>${item.inId || '-'}</td>
                        <td>${item.clientName || '-'}</td>
                        <td>${item.materialName || '-'}</td>
                        <td>${materialType}</td>
                        <td>${item.inCount || 0}개</td>
                        <td class="location-col">${locationDisplay}</td>
                        <td>${item.empName || item.empId || '-'}</td>
                        <td class="status-col">${statusBadge}</td>
                        <td class="inspect-col">${inspectBtn}</td>
                        <td class="complete-time" style="display:none;">${item.completeTime || '-'}</td>
                    </tr>
                `);
            });
        }
    });
}
</script>
</th:block>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">출고 관리</h1>
        
        <div class="card shadow mb-4">
            <div class="card-header py-3">
			    <ul class="nav nav-tabs card-header-tabs">
			        <li class="nav-item">
			            <a class="nav-link" id="material-out-tab" data-toggle="tab" href="#material-out-content">
			                자재 긴급 출고 (공장 투입용)
			            </a>
			        </li>
			        <li class="nav-item">
			            <a class="nav-link active" id="product-out-tab" data-toggle="tab" href="#product-out-content">
			                완제품 출고 (납품)
			            </a>
			        </li>
			    </ul>
			</div>
            
            <div class="card-body">
			    <div class="tab-content">
			        <!-- 자재 출고 탭 -->
			        <div class="tab-pane fade" id="material-out-content">
			            <button class="btn btn-warning mb-3" onclick="openMaterialOutModal()">
			                <i class="fas fa-truck"></i> 자재 출고 등록
			            </button>
			            
			            <div class="table-responsive">
			            </div>
			        </div>
			        
			        <!-- 완제품 출고 탭 -->
			        <div class="tab-pane fade show active" id="product-out-content">
			            <button class="btn btn-success mb-3" onclick="openProductOutModal()">
			                <i class="fas fa-shipping-fast"></i> 완제품 출고 등록
			            </button>
			            <div class="table-responsive">
			            </div>
			        </div>
			    </div>
			</div>
        </div>
    </div>
    
    <!-- 자재 출고 모달 -->
    <div class="modal fade" id="materialOutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">자재 출고 등록 (공장 투입)</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>출고담당자</label>
                            <input type="text" class="form-control" id="material_out_emp" readonly>
                        </div>
                        <div class="col-md-6">
                            <label>출고목적</label>
                            <select class="form-control" id="material_out_purpose">
                                <option value="생산투입">생산투입</option>
                                <option value="긴급투입">긴급투입</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>출고 자재 목록</h6>
                        <button type="button" class="btn btn-sm btn-info" onclick="addMaterialOutRow()">
                            <i class="fas fa-plus"></i> 자재 추가
                        </button>
                    </div>
                    
                    <div id="materialOutList">
                        <div class="material-out-item mb-2">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                                        <option value="">선택하세요</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        선택한 자재: <span id="selectedMaterialOutCount">0</span>종
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="saveMaterialOut()">출고 등록</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 완제품 출고 모달 -->
	<div class="modal fade" id="productOutModal" tabindex="-1">
	    <div class="modal-dialog modal-lg">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title">완제품 출고 등록 (납품)</h5>
	                <button type="button" class="close" data-dismiss="modal">
	                    <span>&times;</span>
	                </button>
	            </div>
	            <div class="modal-body">
	                <div class="row mb-3">
	                    <div class="col-md-12">
	                        <label>출고담당자</label>
	                        <input type="text" class="form-control" id="product_out_emp" readonly>
	                    </div>
	                </div>
	                
	                <hr>
	                <div class="d-flex justify-content-between align-items-center mb-3">
	                    <h6>출고 완제품 목록</h6>
	                    <button type="button" class="btn btn-sm btn-info" onclick="addProductOutRow()">
	                        <i class="fas fa-plus"></i> 제품 추가
	                    </button>
	                </div>
	                
	                <!-- 여기가 누락된 부분 -->
	                <div id="productOutList">
	                    <div class="product-out-item mb-2">
	                        <div class="row">
	                            <div class="col-md-7">
	                                <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
	                                    <option value="">선택하세요</option>
	                                </select>
	                            </div>
	                            <div class="col-md-3">
	                                <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
	                            </div>
	                            <div class="col-md-2">
	                                <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)" style="display:none;">
	                                    <i class="fas fa-trash"></i>
	                                </button>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                
	                <div class="alert alert-info mt-3">
	                    선택한 완제품: <span id="selectedProductOutCount">0</span>종
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
	                <button type="button" class="btn btn-success" onclick="saveProductOut()">출고 등록</button>
	            </div>
	        </div>
	    </div>
	</div>
</th:block>

<th:block layout:fragment="script">
<script>
let currentUser = {};
let materialsData = [];
let productsData = [];

$(document).ready(function() {
    getCurrentUser();
    loadProductOutputList();  
    
    // 탭 전환 이벤트
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        if(target === "#product-out-content") {
            console.log("완제품 출고 탭 활성화");
            loadProductOutputList();
        } else {
            console.log("자재 출고 탭 활성화");
            loadMaterialOutputList();
        }
    });
});

// 현재 로그인 사용자
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUser = data;
            $('#material_out_emp').val(data.empId + ' - ' + data.empName);
            $('#product_out_emp').val(data.empId + ' - ' + data.empName);
        }
    });
}

// ============ 자재 출고 관련 ============

// 자재 출고 모달 열기
function openMaterialOutModal() {
    loadMaterialsForOut();
    $('#materialOutModal').modal('show');
}

// 자재 목록 로드 (warehouse_item 재고 포함)
function loadMaterialsForOut() {
	$.ajax({
        url: '/inventory/api/materials-with-stock',
        type: 'GET',
        success: function(data) {
            materialsData = data;
            
            materialsData.forEach(material => {
                $.ajax({
                    url: `/inventory/api/material-stock-by-manage/${material.materialId}`, 
                    type: 'GET',
                    async: false,
                    success: function(stockData) {
                        material.manageStocks = stockData;
                    }
                });
            });
            
            updateMaterialOutModal();
        }
    });
}

//부품 선택 시 manage_id 선택 가능하도록
function updateMaterialOutModal() {
    let html = `
        <div class="material-out-item mb-3 border p-3">
            <div class="row mb-2">
                <div class="col-md-12">
                    <select class="form-control material-select" onchange="showManageIdOptions(this)">
                        <option value="">부품 선택</option>
                        ${materialsData.map(m => 
                            `<option value="${m.materialId}">${m.materialName} (총 ${m.quantity}개)</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            <div class="manage-id-section" style="display:none;">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>선택</th>
                            <th>Manage ID</th>
                            <th>창고</th>
                            <th>위치</th>
                            <th>재고</th>
                            <th>출고수량</th>
                        </tr>
                    </thead>
                    <tbody class="manage-list"></tbody>
                </table>
            </div>
        </div>
    `;
    
    $('#materialOutList').html(html);
}

//manage_id별 재고 조회 함수
function showManageIdOptions(select) {
    const materialId = $(select).val();
    const container = $(select).closest('.material-out-item');
    const manageSection = container.find('.manage-id-section');
    const manageList = container.find('.manage-list');
    
    if(!materialId) {
        manageSection.hide();
        return;
    }
    
    const material = materialsData.find(m => m.materialId === materialId);
    
    let html = '';
    if(material.manageStocks) {
        material.manageStocks.forEach((stock, index) => {
            html += `
                <tr>
                    <td>
                        <input type="checkbox" class="manage-check" 
                               data-manage="${stock.manageId}"
                               data-warehouse="${stock.warehouseId}"
                               data-location="${stock.locationId}"
                               data-stock="${stock.itemAmount}">
                    </td>
                    <td>${stock.manageId}</td>
                    <td>${stock.warehouseName}</td>
                    <td>${stock.locationId}</td>
                    <td>${stock.itemAmount}개</td>
                    <td>
                        <input type="number" class="form-control form-control-sm out-qty" 
                               min="1" max="${stock.itemAmount}" disabled>
                    </td>
                    <td class="text-muted small">${stock.createDate}</td> 
                </tr>
            `;
        });
    }
    
    manageList.html(html);
    manageSection.show();
    
    // 체크박스 이벤트
    $('.manage-check').on('change', function() {
        const qtyInput = $(this).closest('tr').find('.out-qty');
        if($(this).is(':checked')) {
            qtyInput.prop('disabled', false);
            qtyInput.val(1);
        } else {
            qtyInput.prop('disabled', true);
            qtyInput.val('');
        }
        updateSelectedCount(); // 여기서도 호출
    });
}

//선택한 자재 수 업데이트 함수
function updateSelectedCount() {
    let count = 0;
    $('.manage-check:checked').each(function() {
        count++;
    });
    $('#selectedMaterialOutCount').text(count);
}

// 자재 select 업데이트
function updateAllMaterialOutSelects() {
    $('.material-out-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        materialsData.forEach(item => {
            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
            $(this).append(`<option value="${item.materialId}" data-stock="${item.quantity || 0}">
                ${typeLabel} ${item.materialName} (재고: ${item.quantity || 0}개)
            </option>`);
        });
        
        if(currentValue) $(this).val(currentValue);
    });
    updateSelectedMaterialOutCount();
}

// 자재 행 추가
function addMaterialOutRow() {
    const newRow = `
        <div class="material-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                        <option value="">선택하세요</option>
                        ${materialsData.map(item => {
                            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
                            return `<option value="${item.materialId}" data-stock="${item.quantity || 0}">
                                ${typeLabel} ${item.materialName} (재고: ${item.quantity || 0}개)
                            </option>`
                        }).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#materialOutList').append(newRow);
    if($('.material-out-item').length > 1) {
        $('.remove-material-out').show();
    }
}

// 자재 행 삭제
function removeMaterialOutRow(btn) {
    $(btn).closest('.material-out-item').remove();
    if($('.material-out-item').length === 1) {
        $('.remove-material-out').hide();
    }
    updateSelectedMaterialOutCount();
}

// 선택한 자재 수 업데이트
function updateSelectedMaterialOutCount() {
    let count = 0;
    $('.material-out-select').each(function() {
        if($(this).val()) count++;
    });
    $('#selectedMaterialOutCount').text(count);
}

// 자재 출고 저장
function saveMaterialOut() {
    const items = [];
    
    $('.material-out-item').each(function() {
        const materialId = $(this).find('.material-select').val();
        
        $(this).find('.manage-check:checked').each(function() {
            const qty = $(this).closest('tr').find('.out-qty').val();
            
            if(qty && parseInt(qty) > 0) {
                items.push({
                    productId: materialId,
                    manageId: $(this).data('manage'),
                    warehouseId: $(this).data('warehouse'),
                    locationId: $(this).data('location'),
                    outCount: qty
                });
            }
        });
    });
    
    if(items.length === 0) {
        alert('출고할 항목을 선택하세요.');
        return;
    }
    
    $.ajax({
        url: '/inventory/api/outputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert(`출고 완료!\n배치번호: ${result.batchId}`);
                $('#materialOutModal').modal('hide');
                loadMaterialOutputList();
            }
        }
    });
}

// 자재 폼 초기화
function resetMaterialOutForm() {
    $('#materialOutList').html(`
        <div class="material-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllMaterialOutSelects();
}

// ============ 완제품 출고 관련 ============

// 완제품 출고 모달 열기
function openProductOutModal() {
    loadProductsForOut();
    $('#productOutModal').modal('show');
}

// 완제품 목록 로드 (warehouse_item 재고 포함)
function loadProductsForOut() {
    $.ajax({
        url: '/inventory/api/products-with-stock',
        type: 'GET',
        success: function(data) {
            console.log("완제품 재고:", data);
            productsData = data;
            updateAllProductOutSelects();
        },
        error: function(xhr) {
            console.error("완제품 로드 실패:", xhr);
        }
    });
}

// 완제품 select 업데이트
function updateAllProductOutSelects() {
    $('.product-out-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        productsData.forEach(item => {
            $(this).append(`<option value="${item.productId}" data-stock="${item.quantity || 0}">
                ${item.productName} (재고: ${item.quantity || 0}개)
            </option>`);
        });
        
        if(currentValue) $(this).val(currentValue);
    });
    updateSelectedProductOutCount();
}

// 완제품 행 추가
function addProductOutRow() {
    const newRow = `
        <div class="product-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
                        <option value="">선택하세요</option>
                        ${productsData.map(item => 
                            `<option value="${item.productId}" data-stock="${item.quantity || 0}">
                                ${item.productName} (재고: ${item.quantity || 0}개)
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#productOutList').append(newRow);
    if($('.product-out-item').length > 1) {
        $('.remove-product-out').show();
    }
}

// 완제품 행 삭제
function removeProductOutRow(btn) {
    $(btn).closest('.product-out-item').remove();
    if($('.product-out-item').length === 1) {
        $('.remove-product-out').hide();
    }
    updateSelectedProductOutCount();
}

// 선택한 완제품 수 업데이트
function updateSelectedProductOutCount() {
    let count = 0;
    $('.product-out-select').each(function() {
        if($(this).val()) count++;
    });
    $('#selectedProductOutCount').text(count);
}

// 완제품 출고 저장
function saveProductOut() {
    const items = [];
    
    $('.product-out-item').each(function() {
        const productId = $(this).find('.product-out-select').val();
        const qty = $(this).find('.product-out-qty').val();
        const stock = $(this).find('.product-out-select option:selected').data('stock');
        
        if(productId && qty) {
            if(parseInt(qty) > parseInt(stock)) {
                alert('재고가 부족합니다!');
                return false;
            }
            items.push({
                productId: productId,
                outCount: qty,
                outType: '납품',
            });
        }
    });
    
    if(items.length === 0) {
        alert('최소 하나의 완제품을 선택하세요.');
        return;
    }
    
    $.ajax({
        url: '/inventory/api/outputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert(result.message);
                $('#productOutModal').modal('hide');
                resetProductOutForm();
                loadProductOutputList();
            } else {
                alert('출고 등록 실패: ' + result.message);
            }
        }
    });
}

// 완제품 폼 초기화
function resetProductOutForm() {
    $('#productOutList').html(`
        <div class="product-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllProductOutSelects();
}

// ============ 출고 목록 관련 (batch별) ============

// 자재 출고 목록 로드 함수 확인
function loadMaterialOutputList() {
    $.ajax({
        url: '/inventory/api/outputs/grouped?outType=material',
        type: 'GET',
        success: function(data) {
            console.log("자재 출고 배치 데이터:", data);  // 디버깅
            
            // MOB로 시작하는 배치만 필터
            const materialOutputs = data.filter(item => 
                item.batchId && item.batchId.startsWith('MOB')
            );
            
            console.log("필터링된 데이터:", materialOutputs);
            renderMaterialOutputBatches(materialOutputs);
        },
        error: function(xhr) {
            console.error("자재 출고 목록 로드 실패:", xhr);
        }
    });
}

// 완제품 출고 배치 목록 로드  
function loadProductOutputList() {
    $.ajax({
        url: '/inventory/api/outputs/grouped?outType=product',
        type: 'GET',
        success: function(data) {
            console.log("출고 목록 데이터:", data); 
            renderProductOutputBatches(data); 
        },
        error: function(xhr) {
            console.error("완제품 출고 배치 목록 로드 실패:", xhr);
        }
    });
}

// 자재 출고 배치 목록 렌더링
function renderMaterialOutputBatches(data) {
    let html = `
        <div class="d-flex justify-content-between mb-3">
            <h6>자재 출고 목록</h6>
            <button class="btn btn-danger btn-sm" onclick="deleteSelected('material')" 
                    style="display:none;" id="deleteMaterialBtn">
                <i class="fas fa-trash"></i> 선택 삭제
            </button>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th width="5%">
                        <input type="checkbox" id="checkAllMaterial" onchange="checkAll('material')">
                    </th>
                    <th>배치번호</th>
                    <th>출고일시</th>
                    <th>출고유형</th>
                    <th>품목수</th>
                    <th>총수량</th>
                    <th>상세보기</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="7" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(batch => {
            let typeLabel = '';
            if(batch.batchId && batch.batchId.startsWith('MI')) {
                typeLabel = '<span class="badge badge-warning">재고투입</span>';
            } else {
                typeLabel = '<span class="badge badge-info">생산투입</span>';
            }
            
            html += `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="batch-check material-check" 
                               value="${batch.batchId}" onchange="updateDeleteBtn('material')">
                    </td>
                    <td><strong>${batch.batchId}</strong></td>
                    <td>${batch.outDate} ${batch.outTime}</td>
                    <td>${typeLabel}</td>
                    <td>${batch.itemCount}건</td>
                    <td>${batch.totalCount}개</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showBatchDetail('${batch.batchId}')">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    html += '</tbody></table>';
    $('#material-out-content .table-responsive').html(html);
}

//전체 선택
function checkAll(type) {
    const isChecked = $(`#checkAll${type.charAt(0).toUpperCase() + type.slice(1)}`).prop('checked');
    $(`.${type}-check`).prop('checked', isChecked);
    updateDeleteBtn(type);
}

// 삭제 버튼 표시/숨김
function updateDeleteBtn(type) {
    const checkedCount = $(`.${type}-check:checked`).length;
    if(checkedCount > 0) {
        $(`#delete${type.charAt(0).toUpperCase() + type.slice(1)}Btn`).show();
    } else {
        $(`#delete${type.charAt(0).toUpperCase() + type.slice(1)}Btn`).hide();
    }
}

// 선택 삭제
function deleteSelected(type) {
    const selectedBatches = [];
    $(`.${type}-check:checked`).each(function() {
        selectedBatches.push($(this).val());
    });
    
    if(selectedBatches.length === 0) {
        alert('삭제할 항목을 선택하세요.');
        return;
    }
    
    if(!confirm(`선택한 ${selectedBatches.length}건을 삭제하시겠습니까?\n\n` +
                '⚠️ 주의: 출고 이력이 완전히 삭제됩니다.\n' +
                '재고 수량은 변경되지 않습니다.')) {
        return;
    }
    
    // 배치의 모든 출고 건 조회 후 삭제
    const outIds = [];
    
    Promise.all(selectedBatches.map(batchId => 
        $.ajax({
            url: `/inventory/api/outputs/batch/${batchId}`,
            type: 'GET'
        })
    )).then(results => {
        results.forEach(items => {
            items.forEach(item => {
                outIds.push(item.outId);
            });
        });
        
        // 삭제 처리
        $.ajax({
            url: '/inventory/api/outputs',
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify(outIds),
            headers: {
                'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
            },
            success: function(result) {
                if(result.success) {
                    alert(result.message);
                    // 화면 새로고침
                    if(type === 'material') {
                        loadMaterialOutputList();
                    } else {
                        loadProductOutputList();
                    }
                }
            },
            error: function(xhr) {
                alert('삭제 실패: ' + xhr.responseText);
            }
        });
    });
}

// 완제품 출고 배치 목록 렌더링
function renderProductOutputBatches(data) {
    let html = `
        <div class="d-flex justify-content-between mb-3">
            <h6>완제품 출고 목록</h6>
            <button class="btn btn-danger btn-sm" onclick="deleteSelected('product')" 
                    style="display:none;" id="deleteProductBtn">
                <i class="fas fa-trash"></i> 선택 삭제
            </button>
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th width="5%">
                        <input type="checkbox" id="checkAllProduct" onchange="checkAll('product')">
                    </th>
                    <th>배치번호</th>
                    <th>출고일시</th>
                    <th>품목수</th>
                    <th>총수량</th>
                    <th>상세보기</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="6" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(batch => {
            html += `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="batch-check product-check" 
                               value="${batch.batchId}" onchange="updateDeleteBtn('product')">
                    </td>
                    <td><strong>${batch.batchId}</strong></td>
                    <td>${batch.outDate} ${batch.outTime}</td>
                    <td>${batch.itemCount}건</td>
                    <td>${batch.totalCount}개</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showBatchDetail('${batch.batchId}')">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    html += '</tbody></table>';
    $('#product-out-content .table-responsive').html(html);
}

// 배치 상세보기
function showBatchDetail(batchId) {
    $.ajax({
        url: `/inventory/api/outputs/batch/${batchId}`,
        type: 'GET',
        success: function(data) {
            // 모달 HTML 생성
            let html = `
                <div class="modal fade" id="batchDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">출고 상세 - ${batchId}</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>출고ID</th>
                                            <th>품목</th>
                                            <th>창고</th>
                                            <th>위치</th>
                                            <th>수량</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            let totalQty = 0;
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.outId}</td>
                        <td>${item.materialName || item.productName || '-'}</td>
                        <td>${item.warehouseId}</td>
                        <td>${item.locationId || '-'}</td>
                        <td>${item.outCount}개</td>
                    </tr>
                `;
                totalQty += item.outCount;
            });
            
            html += `
                                    </tbody>
                                </table>
                                <div class="alert alert-info">
                                    총 출고 수량: ${totalQty}개
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거 후 새로 추가
            $('#batchDetailModal').remove();
            $('body').append(html);
            $('#batchDetailModal').modal('show');
        },
        error: function(xhr) {
            alert('상세 조회 실패');
        }
    });
}

//배치 상세 모달
function showBatchDetailModal(data, batchId) {
    let html = `
        <div class="modal fade" id="batchDetailModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            출고 배치 상세: ${batchId}
                            ${batchId.startsWith('MI') ? '<span class="badge badge-warning ml-2">재고투입</span>' : ''}
                        </h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>배치 정보:</strong> ${data.length}건의 출고 항목
                        </div>
                        <table class="table table-sm table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>출고번호</th>
                                    <th>품목ID</th>
                                    <th>품목명</th>
                                    <th>수량</th>
                                    <th>단위</th>
                                    <th>출고담당자</th>
                                    <th>출고사유</th>
                                    <th>출고일시</th>
                                </tr>
                            </thead>
                            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="8" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(item => {
            const productName = item.productName || 'Unknown';
            const productId = item.productId || item.materialId || 'Unknown';
            const unit = item.unit || 'EA';
            const empInfo = item.empName ? `${item.empId} - ${item.empName}` : (item.empId || 'Unknown');
            const outReason = item.outRemark || '-';
            
            html += `
                <tr>
                    <td>${item.outId}</td>
                    <td>${productId}</td>
                    <td>${productName}</td>
                    <td class="text-right">${item.outCount}</td>
                    <td>${unit}</td>
                    <td>${empInfo}</td>
                    <td>${outReason}</td>
                    <td>${item.outDate || '-'}</td>
                </tr>
            `;
        });
    }
    
    html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#batchDetailModal').remove();
    $('body').append(html);
    $('#batchDetailModal').modal('show');
}
</script>
</th:block>
</body>
</html>
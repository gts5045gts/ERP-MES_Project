<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<!-- 외부 라이브러리 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">출고 목록</h1>
        
        <!-- 요약 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">출고대기</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">6건</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">금일 출고완료</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">4건</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">금주 출고완료</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">15건</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">금월 출고완료</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">52건</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form>
                    <div class="row">
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="startDate" value="2025-08-11">
                        </div>
                        <div class="col-md-1 text-center pt-2">
                            <span>~</span>
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="endDate" value="2025-09-10">
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="statusFilter">
                                <option value="">전체 상태</option>
                                <option value="waiting">출고대기</option>
                                <option value="completed">출고완료</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" placeholder="제품명/자재명">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary">
                                <i class="fas fa-search"></i> 검색
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetSearch()">
                                <i class="fas fa-redo"></i> 초기화
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 출고 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">출고 목록</h6>
                <button class="btn btn-success btn-sm" onclick="completeOutbound()">
                    <i class="fas fa-check"></i> 출고 완료
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center" width="100%">
                        <thead class="thead-light">
                            <tr>
                                <th width="5%">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th width="10%">출고ID</th>
                                <th width="20%">제품/자재명</th>
                                <th width="10%">수량</th>
                                <th width="10%">구분</th>
                                <th width="12%">창고명</th>
                                <th width="13%">출고완료일</th>
                                <th width="10%">상태</th>
                                <th width="10%">작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="checkbox" class="item-check" value="145"></td>
                                <td>145</td>
                                <td>포장용기 금형</td>
                                <td>1</td>
                                <td><span class="badge badge-primary">완제품</span></td>
                                <td>완제품 창고3</td>
                                <td>-</td>
                                <td><span class="badge badge-warning">출고대기</span></td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="cancelOutbound('145')">
                                        출고취소
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="item-check" value="144"></td>
                                <td>144</td>
                                <td>전자제품 하우징 금형</td>
                                <td>1</td>
                                <td><span class="badge badge-primary">완제품</span></td>
                                <td>완제품 창고3</td>
                                <td>-</td>
                                <td><span class="badge badge-warning">출고대기</span></td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="cancelOutbound('144')">
                                        출고취소
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="item-check" disabled></td>
                                <td>142</td>
                                <td>스프링</td>
                                <td>10</td>
                                <td><span class="badge badge-info">원자재</span></td>
                                <td>원자재 창고1</td>
                                <td>2025-09-09</td>
                                <td><span class="badge badge-success">출고완료</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="downloadDeliveryPDF('142')">
                                        인쇄(pdf)
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="exportDeliveryExcel('142')">
                                        엑셀
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="item-check" disabled></td>
                                <td>141</td>
                                <td>SUS304 스테인리스강</td>
                                <td>100</td>
                                <td><span class="badge badge-info">원자재</span></td>
                                <td>원자재 창고1</td>
                                <td>2025-09-09</td>
                                <td><span class="badge badge-success">출고완료</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="downloadDeliveryPDF('141')">
                                        인쇄(pdf)
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="exportDeliveryExcel('141')">
                                        엑셀
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 페이지네이션 -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">이전</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">다음</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 출고증 인쇄 모달 -->
    <div class="modal fade" id="deliveryNoteModal" tabindex="-1">
        <!-- 기존 모달 내용 유지 -->
    </div>
    
</th:block>
<th:block layout:fragment="script">
<script>
// 전체 선택
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.item-check:not(:disabled)');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// 검색 초기화
function resetSearch() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('statusFilter').value = '';
    document.querySelector('input[placeholder="제품명/자재명"]').value = '';
}

// 출고 취소
function cancelOutbound(outId) {
    if (confirm('출고를 취소하시겠습니까?')) {
        console.log('출고 취소:', outId);
        // AJAX 처리
    }
}

// 출고 완료 처리
function completeOutbound() {
    const checked = document.querySelectorAll('.item-check:checked');
    if (checked.length === 0) {
        alert('출고 처리할 항목을 선택해주세요.');
        return;
    }
    
    if (confirm(checked.length + '건을 출고 완료 처리하시겠습니까?')) {
        console.log('출고 완료 처리');
        location.reload();
    }
}

// 출고증 Excel 내보내기
function exportDeliveryExcel(outId) {
    // 출고 데이터 가져오기
    fetch(`/inventory/outbound/detail/${outId}`)
        .then(response => response.json())
        .then(data => {
            // Excel 데이터 생성
            const ws_data = [
                ['출고증'],
                [],
                ['출고번호', data.outId || ''],
                ['출고일자', data.outCompleteDate || ''],
                ['담당자', data.empName || ''],
                ['수령처', data.customerName || ''],
                ['배송지', data.deliveryAddress || ''],
                [],
                ['품목코드', '품목명', '창고', '수량'],
                [data.productId || '', data.productName || '', data.warehouseName || '', data.goCount || '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "출고증");
            
            // 파일 다운로드
            XLSX.writeFile(wb, `출고증_${outId}_${new Date().toISOString().slice(0,10)}.xlsx`);
        });
}

//PDF 다운로드 함수 (모달 없이 바로 다운로드)
function downloadDeliveryPDF(outId) {
    // 출고 데이터 가져오기
    fetch(`/inventory/outbound/detail/${outId}`)
        .then(response => response.json())
        .then(data => {
            // PDF 생성을 위한 임시 div 생성
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '210mm';
            tempDiv.innerHTML = generatePDFContent(data);
            document.body.appendChild(tempDiv);
            
            // HTML을 캔버스로 변환 후 PDF 생성
            html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 190; // 여백 고려
                const pageHeight = 277; // 여백 고려
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                // PDF 다운로드
                const date = new Date().toISOString().slice(0, 10);
                pdf.save(`출고증_${outId}_${date}.pdf`);
                
                // 임시 div 제거
                document.body.removeChild(tempDiv);
            });
        })
        .catch(error => {
            console.error('PDF 생성 실패:', error);
            alert('PDF 생성 중 오류가 발생했습니다.');
        });
}

// PDF용 HTML 생성
function generatePDFContent(data) {
	// 템플릿 리터럴(변수를 ${} 안에 넣어 문자열에 포함)
    return `
        <div style="padding: 20px; font-family: 'Malgun Gothic', sans-serif;">
            <h2 style="text-align: center; margin-bottom: 30px;">출 고 증</h2>
            
            <div style="text-align: right; margin-bottom: 20px;">
                <span style="border: 1px solid #000; padding: 5px 10px;">
                    문서번호: OUT-${data.outId || ''}
                </span>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <tr>
                    <td style="border: 1px solid #000; padding: 8px; background: #f5f5f5; width: 25%;">출고번호</td>
                    <td style="border: 1px solid #000; padding: 8px; width: 25%;">${data.outId || ''}</td>
                    <td style="border: 1px solid #000; padding: 8px; background: #f5f5f5; width: 25%;">출고일자</td>
                    <td style="border: 1px solid #000; padding: 8px; width: 25%;">${data.outCompleteDate || '-'}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #000; padding: 8px; background: #f5f5f5;">수령처</td>
                    <td style="border: 1px solid #000; padding: 8px;">${data.customerName || '-'}</td>
                    <td style="border: 1px solid #000; padding: 8px; background: #f5f5f5;">담당자</td>
                    <td style="border: 1px solid #000; padding: 8px;">${data.empName || '-'}</td>
                </tr>
            </table>
            
            <h4 style="margin-top: 30px; margin-bottom: 10px;">출고 품목</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #000; padding: 8px;">품목코드</th>
                        <th style="border: 1px solid #000; padding: 8px;">품목명</th>
                        <th style="border: 1px solid #000; padding: 8px;">창고</th>
                        <th style="border: 1px solid #000; padding: 8px;">수량</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${data.productId || '-'}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${data.productName || '-'}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${data.warehouseName || '-'}</td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: center;">${data.goCount || '0'}</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 50px; text-align: center;">
                <p>부산 정밀</p>
                <p style="font-size: 12px;">부산시 부산진구 중앙대로 | TEL: 051-123-4567</p>
            </div>
        </div>
    `;
}
</script>
</th:block>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">출고 관리</h1>
        
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="material-out-tab" data-toggle="tab" href="#material-out-content">
                            자재 출고 (공장 투입용)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="product-out-tab" data-toggle="tab" href="#product-out-content">
                            완제품 출고 (납품)
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content">
                    <!-- 자재 출고 탭 -->
                    <div class="tab-pane fade show active" id="material-out-content">
                        <button class="btn btn-warning mb-3" onclick="openMaterialOutModal()">
                            <i class="fas fa-truck"></i> 자재 출고 등록
                        </button>
                        
                        <div class="table-responsive">
                            <!-- 여기에 자재 출고 목록 테이블 렌더링 -->
                        </div>
                    </div>
                    
                    <!-- 완제품 출고 탭 -->
                    <div class="tab-pane fade" id="product-out-content">
                        <button class="btn btn-success mb-3" onclick="openProductOutModal()">
                            <i class="fas fa-shipping-fast"></i> 완제품 출고 등록
                        </button>
                        
                        <div class="table-responsive">
                            <!-- 여기에 완제품 출고 목록 테이블 렌더링 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 자재 출고 모달 -->
    <div class="modal fade" id="materialOutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">자재 출고 등록 (공장 투입)</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>출고담당자</label>
                            <input type="text" class="form-control" id="material_out_emp" readonly>
                        </div>
                        <div class="col-md-6">
                            <label>출고목적</label>
                            <select class="form-control" id="material_out_purpose">
                                <option value="생산투입">생산투입</option>
                                <option value="긴급투입">긴급투입</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>출고 자재 목록</h6>
                        <button type="button" class="btn btn-sm btn-info" onclick="addMaterialOutRow()">
                            <i class="fas fa-plus"></i> 자재 추가
                        </button>
                    </div>
                    
                    <div id="materialOutList">
                        <div class="material-out-item mb-2">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                                        <option value="">선택하세요</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        선택한 자재: <span id="selectedMaterialOutCount">0</span>종
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="saveMaterialOut()">출고 등록</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 완제품 출고 모달 -->
    <div class="modal fade" id="productOutModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">완제품 출고 등록 (납품)</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>출고담당자</label>
                            <input type="text" class="form-control" id="product_out_emp" readonly>
                        </div>
                        <div class="col-md-6">
                            <label>거래처</label>
                            <select class="form-control" id="product_out_client">
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>출고 완제품 목록</h6>
                        <button type="button" class="btn btn-sm btn-info" onclick="addProductOutRow()">
                            <i class="fas fa-plus"></i> 제품 추가
                        </button>
                    </div>
                    
                    <div id="productOutList">
                        <div class="product-out-item mb-2">
                            <div class="row">
                                <div class="col-md-7">
                                    <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
                                        <option value="">선택하세요</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        선택한 완제품: <span id="selectedProductOutCount">0</span>종
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="saveProductOut()">출고 등록</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script>
let currentUser = {};
let materialsData = [];
let productsData = [];

$(document).ready(function() {
    getCurrentUser();
    loadMaterialOutputList();
    
    // 탭 전환 이벤트
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        if(target === "#product-out-content") {
            loadProductOutputList();
        } else {
            loadMaterialOutputList();
        }
    });
});

// 현재 로그인 사용자
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUser = data;
            $('#material_out_emp').val(data.empId + ' - ' + data.empName);
            $('#product_out_emp').val(data.empId + ' - ' + data.empName);
        }
    });
}

// ============ 자재 출고 관련 ============

// 자재 출고 모달 열기
function openMaterialOutModal() {
    loadMaterialsForOut();
    $('#materialOutModal').modal('show');
}

// 자재 목록 로드 (warehouse_item 재고 포함)
function loadMaterialsForOut() {
    $.ajax({
        url: '/inventory/api/materials-with-stock',  // 새 API 엔드포인트
        type: 'GET',
        success: function(data) {
            console.log("자재 재고:", data);
            materialsData = data;
            updateAllMaterialOutSelects();
        },
        error: function(xhr) {
            console.error("자재 로드 실패:", xhr);
        }
    });
}

// 자재 select 업데이트
function updateAllMaterialOutSelects() {
    $('.material-out-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        materialsData.forEach(item => {
            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
            $(this).append(`<option value="${item.materialId}" data-stock="${item.quantity || 0}">
                ${typeLabel} ${item.materialName} (재고: ${item.quantity || 0}개)
            </option>`);
        });
        
        if(currentValue) $(this).val(currentValue);
    });
    updateSelectedMaterialOutCount();
}

// 자재 행 추가
function addMaterialOutRow() {
    const newRow = `
        <div class="material-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                        <option value="">선택하세요</option>
                        ${materialsData.map(item => {
                            const typeLabel = item.materialType === '부품' ? '[부품]' : '[반제품]';
                            return `<option value="${item.materialId}" data-stock="${item.quantity || 0}">
                                ${typeLabel} ${item.materialName} (재고: ${item.quantity || 0}개)
                            </option>`
                        }).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#materialOutList').append(newRow);
    if($('.material-out-item').length > 1) {
        $('.remove-material-out').show();
    }
}

// 자재 행 삭제
function removeMaterialOutRow(btn) {
    $(btn).closest('.material-out-item').remove();
    if($('.material-out-item').length === 1) {
        $('.remove-material-out').hide();
    }
    updateSelectedMaterialOutCount();
}

// 선택한 자재 수 업데이트
function updateSelectedMaterialOutCount() {
    let count = 0;
    $('.material-out-select').each(function() {
        if($(this).val()) count++;
    });
    $('#selectedMaterialOutCount').text(count);
}

// 자재 출고 저장
function saveMaterialOut() {
    console.log("saveMaterialOut 함수 시작"); // 디버깅용
    
    const items = [];
    let hasError = false;
    
    $('.material-out-item').each(function() {
        const materialId = $(this).find('.material-out-select').val();
        const qty = $(this).find('.material-out-qty').val();
        const stock = $(this).find('.material-out-select option:selected').data('stock');
        
        console.log(`materialId: ${materialId}, qty: ${qty}, stock: ${stock}`); // 디버깅용
        
        if(materialId && qty) {
            if(parseInt(qty) > parseInt(stock)) {
                alert('재고가 부족합니다!');
                hasError = true;
                return false; // 루프 중단
            }
            items.push({
                productId: materialId,
                outCount: qty,
                outType: $('#material_out_purpose').val()
            });
        }
    });
    
    if(hasError) return; // 에러가 있으면 중단
    
    console.log("전송할 데이터:", items); // 디버깅용
    
    if(items.length === 0) {
        alert('최소 하나의 자재를 선택하세요.');
        return;
    }
    
    // 버튼 비활성화 (중복 클릭 방지)
    const saveBtn = $(event.target);
    saveBtn.prop('disabled', true).text('처리중...');
    
    $.ajax({
        url: '/inventory/api/outputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            console.log("서버 응답:", result); // 디버깅용
            if(result.success) {
                alert(result.message);
                $('#materialOutModal').modal('hide');
                resetMaterialOutForm();
                loadMaterialOutputList();
            } else {
                alert('출고 등록 실패: ' + result.message);
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX 에러:", xhr, status, error); // 디버깅용
            alert('서버 오류: ' + xhr.responseText);
        },
        complete: function() {
            // 버튼 다시 활성화
            saveBtn.prop('disabled', false).text('출고 등록');
        }
    });
}

// 자재 폼 초기화
function resetMaterialOutForm() {
    $('#materialOutList').html(`
        <div class="material-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control material-out-select" onchange="updateSelectedMaterialOutCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control material-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-material-out" onclick="removeMaterialOutRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllMaterialOutSelects();
}

// ============ 완제품 출고 관련 ============

// 완제품 출고 모달 열기
function openProductOutModal() {
    loadProductsForOut();
    loadClients();
    $('#productOutModal').modal('show');
}

// 완제품 목록 로드 (warehouse_item 재고 포함)
function loadProductsForOut() {
    $.ajax({
        url: '/inventory/api/products-with-stock',  // 새 API 엔드포인트
        type: 'GET',
        success: function(data) {
            console.log("완제품 재고:", data);
            productsData = data;
            updateAllProductOutSelects();
        },
        error: function(xhr) {
            console.error("완제품 로드 실패:", xhr);
        }
    });
}

// 완제품 select 업데이트
function updateAllProductOutSelects() {
    $('.product-out-select').each(function() {
        const currentValue = $(this).val();
        $(this).empty();
        $(this).append('<option value="">선택하세요</option>');
        
        productsData.forEach(item => {
            $(this).append(`<option value="${item.productId}" data-stock="${item.quantity || 0}">
                ${item.productName} (재고: ${item.quantity || 0}개)
            </option>`);
        });
        
        if(currentValue) $(this).val(currentValue);
    });
    updateSelectedProductOutCount();
}

// 완제품 행 추가
function addProductOutRow() {
    const newRow = `
        <div class="product-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
                        <option value="">선택하세요</option>
                        ${productsData.map(item => 
                            `<option value="${item.productId}" data-stock="${item.quantity || 0}">
                                ${item.productName} (재고: ${item.quantity || 0}개)
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#productOutList').append(newRow);
    if($('.product-out-item').length > 1) {
        $('.remove-product-out').show();
    }
}

// 완제품 행 삭제
function removeProductOutRow(btn) {
    $(btn).closest('.product-out-item').remove();
    if($('.product-out-item').length === 1) {
        $('.remove-product-out').hide();
    }
    updateSelectedProductOutCount();
}

// 선택한 완제품 수 업데이트
function updateSelectedProductOutCount() {
    let count = 0;
    $('.product-out-select').each(function() {
        if($(this).val()) count++;
    });
    $('#selectedProductOutCount').text(count);
}

// 완제품 출고 저장
function saveProductOut() {
    const items = [];
    const clientId = $('#product_out_client').val();
    
    if(!clientId) {
        alert('거래처를 선택하세요.');
        return;
    }
    
    $('.product-out-item').each(function() {
        const productId = $(this).find('.product-out-select').val();
        const qty = $(this).find('.product-out-qty').val();
        const stock = $(this).find('.product-out-select option:selected').data('stock');
        
        if(productId && qty) {
            if(parseInt(qty) > parseInt(stock)) {
                alert('재고가 부족합니다!');
                return false;
            }
            items.push({
                productId: productId,
                outCount: qty,
                outType: '납품',
                clientId: clientId
            });
        }
    });
    
    if(items.length === 0) {
        alert('최소 하나의 완제품을 선택하세요.');
        return;
    }
    
    $.ajax({
        url: '/inventory/api/outputs/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(items),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: function(result) {
            if(result.success) {
                alert(result.message);
                $('#productOutModal').modal('hide');
                resetProductOutForm();
                loadProductOutputList();
            } else {
                alert('출고 등록 실패: ' + result.message);
            }
        }
    });
}

// 완제품 폼 초기화
function resetProductOutForm() {
    $('#productOutList').html(`
        <div class="product-out-item mb-2">
            <div class="row">
                <div class="col-md-7">
                    <select class="form-control product-out-select" onchange="updateSelectedProductOutCount()">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control product-out-qty" placeholder="수량" min="1">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-danger btn-sm remove-product-out" onclick="removeProductOutRow(this)" style="display:none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `);
    updateAllProductOutSelects();
}

// 거래처 목록 로드
function loadClients() {
    $.ajax({
        url: '/inventory/api/clients',
        type: 'GET',
        success: function(data) {
            const select = $('#product_out_client');
            select.empty();
            select.append('<option value="">선택하세요</option>');
            data.forEach(client => {
                select.append(`<option value="${client.clientId}">${client.clientName}</option>`);
            });
        }
    });
}

// ============ 출고 목록 관련 ============

// 자재 출고 목록 로드
function loadMaterialOutputList() {
    $.ajax({
        url: '/inventory/api/outputs',
        type: 'GET',
        success: function(data) {
            // 자재 출고만 필터링 (material_id가 있고 product_id가 빈 문자열인 것)
            const materialData = data.filter(item => 
                item.materialId && item.materialId !== '' && 
                (!item.productId || item.productId === '')
            );
            renderMaterialOutputTable(materialData);
        }
    });
}

// 자재 출고 테이블 렌더링
function renderMaterialOutputTable(data) {
    let html = `
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>출고번호</th>
                    <th>자재명</th>
                    <th>수량</th>
                    <th>상태</th>
                    <th>출고일</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="6" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(item => {
            const statusBadge = item.ouType === '출고완료' ? 
                '<span class="badge badge-success">완료</span>' : 
                '<span class="badge badge-warning">대기</span>';
            
            html += `
            	<tr>
	                <td>${item.outId}</td>
	                <td>${item.productId}</td>
	                <td>${item.outCount}개</td>
	                <td><span class="badge badge-success">완료</span></td>  <!-- 항상 완료 -->
	                <td>${item.outDate || '-'}</td>
	                <td>-</td>  <!-- 작업 버튼 제거 -->
	            </tr>
            `;
        });
    }
    
    html += '</tbody></table>';
    $('#material-out-content .table-responsive').html(html);
}

// 완제품 출고 목록 로드
function loadProductOutputList() {
    $.ajax({
        url: '/inventory/api/outputs',
        type: 'GET',
        success: function(data) {
            // 완제품 출고만 필터링 (product_id가 있고 material_id가 빈 문자열인 것)
            const productData = data.filter(item => 
                item.productId && item.productId !== '' && 
                (!item.materialId || item.materialId === '')
            );
            renderProductOutputTable(productData);
        }
    });
}

// 완제품 출고 테이블 렌더링
function renderProductOutputTable(data) {
    let html = `
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>출고번호</th>
                    <th>제품명</th>
                    <th>수량</th>
                    <th>거래처</th>
                    <th>상태</th>
                    <th>출고일</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if(data.length === 0) {
        html += '<tr><td colspan="7" class="text-center">데이터가 없습니다.</td></tr>';
    } else {
        data.forEach(item => {
            const statusBadge = item.outType === '출고완료' ? 
                '<span class="badge badge-success">완료</span>' : 
                '<span class="badge badge-warning">대기</span>';
            
            html += `
                <tr>
                    <td>${item.outId}</td>
                    <td>${item.productId}</td>
                    <td>${item.outCount}개</td>
                    <td><span class="badge badge-success">완료</span></td>  
                    <td>${item.outDate || '-'}</td>
                    <td>-</td> 
                </tr>
            `;
        });
    }
    
    html += '</tbody></table>';
    $('#product-out-content .table-responsive').html(html);
}

// 출고 완료 처리
function completeOutput(outId) {
    if(confirm('출고를 완료하시겠습니까?')) {
        $.ajax({
            url: `/inventory/api/outputs/${outId}/complete`,
            type: 'PUT',
            headers: {
                'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
            },
            success: function(result) {
                if(result.success) {
                    alert('출고 완료!');
                    loadMaterialOutputList();
                    loadProductOutputList();
                }
            }
        });
    }
}
</script>
</th:block>
</body>
</html>
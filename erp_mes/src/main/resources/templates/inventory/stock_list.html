<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">재고 현황</h1>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" id="productName" class="form-control" placeholder="품목명 검색">
                        </div>
                        <div class="col-md-2">
                            <select id="warehouseId" class="form-control">
                                <option value="">전체 창고</option>
                                <option th:each="warehouse : ${warehouseList}" 
                                        th:value="${warehouse.warehouseId}"
                                        th:text="${warehouse.warehouseName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" id="searchBtn" class="btn btn-primary">검색</button>
                            <button type="button" id="resetBtn" class="btn btn-secondary">초기화</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 재고 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">재고 목록</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%">
                        <thead>
						    <tr>
						        <th>번호</th>
						        <th>품목 코드</th>
						        <th>품목명</th>
						        <th>품목 유형</th>
						        <th>전체 재고</th> 
						        <th>재고조정</th>
						    </tr>
						</thead>
                        <tbody id="stockTableBody">
                            <tr th:if="${#lists.isEmpty(inventoryList)}">
                                <td colspan="7" class="text-center">조회된 재고가 없습니다.</td>
                            </tr>
                            <tr th:each="inv : ${inventoryList}">
                                <td th:text="${inv.manageId}"></td>
                                <td th:text="${inv.productId}"></td>
                                <td th:text="${inv.productName}"></td>
                                <td th:text="${inv.productType}"></td>
                                <td th:text="${inv.itemAmount}"></td>
                                <td>
                                    <button class="btn btn-sm btn-info">상세</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal fade" id="stockAdjustModal" tabindex="-1">
		    <div class="modal-dialog modal-lg">
		        <div class="modal-content">
		            <div class="modal-header">
		                <h5 class="modal-title">재고 조정</h5>
		                <button type="button" class="close" data-dismiss="modal">
		                    <span>&times;</span>
		                </button>
		            </div>
		            <div class="modal-body">
		                <div class="mb-3">
		                    <h6>품목: <span id="modal_productName"></span> (<span id="modal_productId"></span>)</h6>
		                </div>
		                <table class="table table-bordered">
		                    <thead>
		                        <tr>
		                            <th>창고명</th>
		                            <th>현재고</th>
		                            <th>조정유형</th>
		                            <th>조정수량</th>
		                            <th>조정후재고</th>
		                        </tr>
		                    </thead>
		                    <tbody id="warehouseStockBody">
		                    </tbody>
		                </table>
		                <div class="form-group">
		                    <label>조정사유</label>
		                    <input type="text" class="form-control" id="adjustReason" placeholder="조정 사유 입력">
		                </div>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
		                <button type="button" class="btn btn-primary" onclick="saveStockAdjust()">저장</button>
		            </div>
		        </div>
		    </div>
		</div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script th:inline="javascript">
// 전역 변수
let currentProductId = null;
let warehouseStockData = [];
let token = null;
let header = null;

$(document).ready(function() {
    console.log("재고 페이지 스크립트 시작"); 
    
    // CSRF 토큰 설정
    token = $("meta[name='_csrf']").attr("content");
    header = $("meta[name='_csrf_header']").attr("content");
    
    loadStockList();
    
    // 검색 버튼 클릭
    $('#searchBtn').click(function() {
        loadStockList();
    });
    
    // 초기화 버튼 클릭
    $('#resetBtn').click(function() {
        $('#productName').val('');
        $('#warehouseId').val('');
        loadStockList();
    });
});

// 재고 목록 조회 함수
function loadStockList() {
    console.log("loadStockList 호출됨");
    
    const productName = $('#productName').val();
    const warehouseId = $('#warehouseId').val();
    
    $.ajax({
        url: '/api/inventory/stock',
        type: 'GET',
        data: {
            productName: productName,
            warehouseId: warehouseId
        },
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function(data) {
            console.log("조회 성공:", data);
            displayStockList(data);
        },
        error: function(xhr, status, error) {
            console.error('재고 목록 조회 실패:', error);
            alert('재고 목록을 불러오는데 실패했습니다.');
        }
    });
}

// 재고 목록 표시 함수
function displayStockList(stockList) {
    let html = '';
    
    if(stockList.length === 0) {
        html = '<tr><td colspan="6" class="text-center">조회된 재고가 없습니다.</td></tr>';
    } else {
        stockList.forEach(function(stock, index) {
            html += '<tr>';
            html += '<td>' + (index + 1) + '</td>';
            html += '<td>' + stock.productId + '</td>';
            html += '<td>' + stock.productName + '</td>';
            html += '<td>' + stock.productType + '</td>';
            html += '<td class="text-right">' + (stock.quantity || 0) + '</td>';
            html += '<td class="text-center">';
            html += '<button class="btn btn-sm btn-info" onclick="openStockModal(\'' + stock.productId + '\', \'' + stock.productName + '\')">재고조정</button>';
            html += '</td>';
            html += '</tr>';
        });
    }
    
    $('#stockTableBody').html(html);
}

// 재고조정 모달 열기 - 전역 함수
function openStockModal(productId, productName) {
    console.log('재고조정 모달 열기:', productId, productName);
    
    currentProductId = productId;
    $('#modal_productName').text(productName);
    $('#modal_productId').text(productId);
    
    // 창고별 재고 조회
    $.ajax({
        url: '/api/inventory/warehouse-stock/' + productId,
        type: 'GET',
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function(data) {
            console.log('창고별 재고:', data);
            warehouseStockData = data;
            displayWarehouseStock(data);
            $('#stockAdjustModal').modal('show');
        },
        error: function(xhr) {
            console.error('에러:', xhr);
            alert('창고별 재고 조회 실패');
        }
    });
}

// 창고별 재고 표시
function displayWarehouseStock(data) {
	let html = '';
    
    if(!data || data.length === 0) {
        html = '<tr><td colspan="6" class="text-center">해당 제품 유형에 맞는 운영중인 창고가 없습니다.</td></tr>';
    } else {
        data.forEach(function(item, index) {
            const currentQty = item.itemAmount || 0;
            const locationCount = item.locationCount || 0;
            
            html += '<tr>';
            html += '<td>' + (item.warehouseName || '창고명 없음') + '</td>';
            html += '<td class="text-center">' + locationCount + '개 위치</td>';  // 위치 개수 추가
            html += '<td class="text-center"><strong>' + currentQty + '</strong></td>';
            html += '<td>';
            html += '<select class="form-control form-control-sm adjust-type" data-index="' + index + '">';
            html += '<option value="">선택</option>';
            html += '<option value="IN">입고</option>';
            html += '<option value="OUT">출고</option>';
            html += '</select>';
            html += '</td>';
            html += '<td>';
            html += '<input type="number" class="form-control form-control-sm adjust-qty" data-index="' + index + '" min="0" disabled>';
            html += '</td>';
            html += '<td class="text-center after-qty">-</td>';
            html += '</tr>';
        });
    }
    
    $('#warehouseStockBody').html(html);
    
    // 이벤트 바인딩
    $('.adjust-type').on('change', function() {
        const index = $(this).data('index');
        const qtyInput = $('.adjust-qty[data-index="' + index + '"]');
        
        if($(this).val()) {
            qtyInput.prop('disabled', false);
        } else {
            qtyInput.prop('disabled', true).val('');
            updateAfterQty(index);
        }
    });
    
    $('.adjust-qty').on('input', function() {
        const index = $(this).data('index');
        updateAfterQty(index);
    });
}

// 조정 후 재고 계산
function updateAfterQty(index) {
    const type = $('.adjust-type[data-index="' + index + '"]').val();
    const adjustQty = parseInt($('.adjust-qty[data-index="' + index + '"]').val()) || 0;
    const currentQty = warehouseStockData[index].itemAmount || 0;
    
    let afterQty = currentQty;
    if(type === 'IN') {
        afterQty = currentQty + adjustQty;
    } else if(type === 'OUT') {
        afterQty = currentQty - adjustQty;
        if(afterQty < 0) {
            alert('재고가 부족합니다!');
            $('.adjust-qty[data-index="' + index + '"]').val(currentQty);
            afterQty = 0;
        }
    }
    
    $('.after-qty').eq(index).text(type ? afterQty : '-');
}

// 재고조정 저장
function saveStockAdjust() {
    const adjustments = [];
    
    $('.adjust-type').each(function(index) {
        const type = $(this).val();
        const qty = parseInt($('.adjust-qty[data-index="' + index + '"]').val()) || 0;
        
        if(type && qty > 0) {
            adjustments.push({
                warehouseId: warehouseStockData[index].warehouseId,
                warehouseName: warehouseStockData[index].warehouseName,
                adjustType: type,
                adjustQty: qty
            });
        }
    });
    
    if(adjustments.length === 0) {
        alert('조정할 항목을 입력하세요.');
        return;
    }
    
    const reason = $('#adjustReason').val();
    
    // 각 창고별로 조정 처리
    let successCount = 0;
    adjustments.forEach(function(adj) {
        $.ajax({
            url: '/api/inventory/adjust-stock',
            type: 'POST',
            data: {
                productId: currentProductId,
                warehouseId: adj.warehouseId,
                adjustQty: adj.adjustQty,
                adjustType: adj.adjustType,
                reason: reason
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(result) {
                successCount++;
                if(successCount === adjustments.length) {
                    alert('재고 조정 완료');
                    $('#stockAdjustModal').modal('hide');
                    loadStockList(); // 목록 새로고침
                }
            },
            error: function() {
                alert(adj.warehouseName + ' 창고 조정 실패');
            }
        });
    });
}
</script>
</th:block>
</body>
</html>
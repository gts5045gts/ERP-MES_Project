<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">재고 현황</h1>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" id="productName" class="form-control" placeholder="품목명 검색">
                        </div>
                        <div class="col-md-2">
                            <select id="warehouseId" class="form-control">
                                <option value="">전체 창고</option>
                                <option th:each="warehouse : ${warehouseList}" 
                                        th:value="${warehouse.warehouseId}"
                                        th:text="${warehouse.warehouseName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" id="searchBtn" class="btn btn-primary">검색</button>
                            <button type="button" id="resetBtn" class="btn btn-secondary">초기화</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 재고 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">재고 목록</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%">
                        <thead>
                            <tr>
                                <th>재고번호</th>
                                <th>품목 코드</th>
                                <th>품목 이름</th>
                                <th>품목 종류</th>
                                <th>수량</th>
                                <th>창고명</th>
                                <th>재고조정</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <!-- 데이터가 없을 때 -->
                            <tr th:if="${#lists.isEmpty(inventoryList)}">
                                <td colspan="7" class="text-center">조회된 재고가 없습니다.</td>
                            </tr>
                            
                            <!-- 데이터가 있을 때 -->
                            <tr th:each="inv : ${inventoryList}">
                                <td th:text="${inv.manageId}"></td>
                                <td th:text="${inv.productId}"></td>
                                <td th:text="${inv.productName}"></td>
                                <td th:text="${inv.productType}"></td>
                                <td th:text="${inv.itemAmount}"></td>
                                <td th:text="${inv.warehouseName}"></td>
                                <td>
                                    <button class="btn btn-sm btn-info">상세</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script th:inline="javascript">
$(document).ready(function() {
    console.log("재고 페이지 스크립트 시작");  // 디버깅용
    
    // CSRF 토큰 설정
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    
    // 페이지 로드시 재고 목록 조회
    loadStockList();
    
    // 검색 버튼 클릭
    $('#searchBtn').click(function() {
        loadStockList();
    });
    
    // 초기화 버튼 클릭
    $('#resetBtn').click(function() {
        $('#productName').val('');
        $('#warehouseId').val('');
        loadStockList();
    });
    
    // 재고 목록 조회 함수
    function loadStockList() {
        console.log("loadStockList 호출됨");  // 디버깅용
        
        const productName = $('#productName').val();
        const warehouseId = $('#warehouseId').val();
        
        $.ajax({
            url: '/api/inventory/stock',
            type: 'GET',
            data: {
                productName: productName,
                warehouseId: warehouseId
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(data) {
                console.log("조회 성공:", data);  // 디버깅용
                displayStockList(data);
            },
            error: function(xhr, status, error) {
                console.error('재고 목록 조회 실패:', error);
                alert('재고 목록을 불러오는데 실패했습니다.');
            }
        });
    }
    
    // 재고 목록 표시 함수
    function displayStockList(stockList) {
    let html = '';
    
    if(stockList.length === 0) {
        html = '<tr><td colspan="7" class="text-center">조회된 재고가 없습니다.</td></tr>';
    } else {
        stockList.forEach(function(stock, index) {
            html += '<tr>';
            html += '<td>' + (index + 1) + '</td>';  // 재고번호는 순번으로
            html += '<td>' + stock.productId + '</td>';  // 품목 코드
            html += '<td>' + stock.productName + '</td>';  // 품목 이름
            html += '<td>' + stock.productType + '</td>';  // 품목 종류
            html += '<td class="text-right">' + (stock.itemAmount || 0) + '</td>';  // 수량
            html += '<td>' + stock.warehouseName + '</td>';  // 창고명
            html += '<td class="text-center">';
            html += '<button class="btn btn-sm btn-info">상세</button>';
            html += '</td>';
            html += '</tr>';
        });
    }
    
    $('#stockTableBody').html(html);
}
});
</script>
</th:block>
</body>
</html>